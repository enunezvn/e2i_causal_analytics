# Orchestrator Dispatch Contract

## Overview

This contract defines the format for dispatching requests from the Orchestrator to downstream agents.

## Dispatch Request Schema

```yaml
dispatch_request:
  # Required fields
  request_id: string          # Unique request identifier (UUID)
  timestamp: string           # ISO 8601 timestamp
  intent: string              # Classified intent type
  target_agent: string        # Agent to receive request
  
  # Query context
  query:
    original: string          # User's original query
    normalized: string        # Cleaned/normalized query
    entities: list            # Extracted entities
    
  # Execution parameters
  execution:
    timeout_ms: int           # Max execution time
    priority: string          # "high" | "normal" | "low"
    fallback_agent: string    # Agent to use if primary fails
    
  # Context payload
  context:
    brand: string             # Brand context (if applicable)
    user_expertise: string    # "executive" | "analyst" | "data_scientist"
    session_id: string        # Session identifier
    prior_results: list       # Results from prior agents in chain
    
  # Optional metadata
  metadata:
    source: string            # Request source
    trace_id: string          # Distributed trace ID
    correlation_id: string    # Correlation ID for related requests
```

## Intent Types

| Intent | Description | Primary Agent | Fallback |
|--------|-------------|---------------|----------|
| `causal_effect_estimation` | Estimate causal effect of treatment | causal_impact | gap_analyzer |
| `roi_opportunity_detection` | Find ROI opportunities | gap_analyzer | resource_optimizer |
| `cate_estimation` | Heterogeneous treatment effects | heterogeneous_optimizer | causal_impact |
| `experiment_design` | Design causal experiment | experiment_designer | causal_impact |
| `drift_detection` | Check for data/model drift | drift_monitor | health_score |
| `system_health` | Check system health | health_score | drift_monitor |
| `prediction_request` | Generate predictions | prediction_synthesizer | - |
| `resource_allocation` | Optimize resource allocation | resource_optimizer | gap_analyzer |
| `explanation_request` | Explain analysis results | explainer | - |
| `feedback_submission` | Submit feedback | feedback_learner | - |
| `general_query` | General analytical query | causal_impact | explainer |

## Example Dispatch

```yaml
dispatch_request:
  request_id: "550e8400-e29b-41d4-a716-446655440000"
  timestamp: "2025-01-15T10:30:00Z"
  intent: "causal_effect_estimation"
  target_agent: "causal_impact"
  
  query:
    original: "What is the effect of HCP targeting on Kisqali prescriptions?"
    normalized: "effect hcp targeting kisqali prescriptions"
    entities:
      - type: "treatment"
        value: "HCP targeting"
      - type: "outcome"
        value: "prescriptions"
      - type: "brand"
        value: "Kisqali"
  
  execution:
    timeout_ms: 60000
    priority: "normal"
    fallback_agent: "gap_analyzer"
  
  context:
    brand: "Kisqali"
    user_expertise: "analyst"
    session_id: "sess_abc123"
    prior_results: []
  
  metadata:
    source: "web_ui"
    trace_id: "trace_xyz789"
    correlation_id: "corr_def456"
```

## Validation Rules

1. **request_id**: Must be valid UUID v4
2. **timestamp**: Must be valid ISO 8601
3. **intent**: Must be from valid intent types
4. **target_agent**: Must be registered agent
5. **timeout_ms**: Must be > 0 and < 300000 (5 minutes)
6. **priority**: Must be "high", "normal", or "low"

## Error Handling

If dispatch fails, Orchestrator should:
1. Log error with request_id and trace_id
2. Attempt fallback_agent if specified
3. Return graceful error to user if all agents fail

```yaml
dispatch_error:
  request_id: string
  error_code: string
  error_message: string
  attempted_agent: string
  fallback_attempted: bool
  timestamp: string
```
