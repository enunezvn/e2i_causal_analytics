<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E2I Causal Validation Protocol v1.0</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #4ecdc4;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #fc8181;
            --info: #63b3ed;
            --bg-dark: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border: #4a5568;
            --node-graph: #667eea;
            --node-estimation: #9f7aea;
            --node-refutation: #ed8936;
            --node-sensitivity: #4ecdc4;
            --node-interpretation: #48bb78;
            --technique-primary: #667eea;
            --technique-secondary: #4ecdc4;
            --technique-tertiary: #a0aec0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #2d3748 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 50px;
            padding: 40px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(78, 205, 196, 0.2) 100%);
            border-radius: 20px;
            border: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .header .version-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Section Styling */
        .section {
            margin-bottom: 50px;
        }
        
        .section-header {
            margin-bottom: 30px;
        }
        
        .section-header h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-header h2 .icon {
            font-size: 1.5rem;
        }
        
        .section-header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .card-icon.primary { background: linear-gradient(135deg, var(--technique-primary), #818cf8); }
        .card-icon.secondary { background: linear-gradient(135deg, var(--technique-secondary), #5eead4); }
        .card-icon.tertiary { background: linear-gradient(135deg, var(--technique-tertiary), #94a3b8); }
        .card-icon.refutation { background: linear-gradient(135deg, var(--node-refutation), #f6ad55); }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        /* Workflow Diagram */
        .workflow-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .workflow-nodes {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 900px;
            gap: 10px;
        }
        
        .workflow-node {
            flex: 0 0 auto;
            width: 150px;
            text-align: center;
            position: relative;
        }
        
        .node-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 1.8rem;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .node-circle.graph { background: var(--node-graph); }
        .node-circle.estimation { background: var(--node-estimation); }
        .node-circle.refutation { background: var(--node-refutation); border-color: white; box-shadow: 0 0 20px rgba(237, 137, 54, 0.5); }
        .node-circle.sensitivity { background: var(--node-sensitivity); }
        .node-circle.interpretation { background: var(--node-interpretation); }
        
        .node-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .node-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .workflow-arrow {
            flex: 0 0 auto;
            color: var(--text-muted);
            font-size: 1.5rem;
        }
        
        .node-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* Priority Indicator */
        .priority-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 900px) {
            .priority-section {
                grid-template-columns: 1fr;
            }
        }
        
        .priority-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 2px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        
        .priority-card.primary {
            border-color: var(--technique-primary);
        }
        
        .priority-card.secondary {
            border-color: var(--technique-secondary);
        }
        
        .priority-card.tertiary {
            border-color: var(--technique-tertiary);
        }
        
        .priority-rank {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .priority-rank.primary { background: var(--technique-primary); }
        .priority-rank.secondary { background: var(--technique-secondary); }
        .priority-rank.tertiary { background: var(--technique-tertiary); }
        
        .priority-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
            padding-right: 50px;
        }
        
        .priority-when {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .priority-integration {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
        }
        
        /* Refutation Tests Table */
        .tests-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .tests-table th,
        .tests-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .tests-table th {
            background: rgba(102, 126, 234, 0.2);
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .tests-table td {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .tests-table tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
        
        .test-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .pass-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .pass-indicator.pass { background: rgba(72, 187, 120, 0.2); color: var(--success); }
        .pass-indicator.warn { background: rgba(237, 137, 54, 0.2); color: var(--warning); }
        .pass-indicator.fail { background: rgba(252, 129, 129, 0.2); color: var(--danger); }
        
        /* Code Block */
        .code-block {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.7;
            margin: 16px 0;
        }
        
        .code-block .comment { color: #6a9955; }
        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .function { color: #dcdcaa; }
        .code-block .class { color: #4ec9b0; }
        .code-block .number { color: #b5cea8; }
        
        /* Integration Diagram */
        .integration-flow {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }
        
        @media (max-width: 900px) {
            .integration-flow {
                grid-template-columns: 1fr;
            }
        }
        
        .flow-stage {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .flow-stage-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }
        
        .flow-stage-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .flow-stage-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .flow-arrow-down {
            text-align: center;
            font-size: 1.5rem;
            color: var(--text-muted);
            padding: 10px 0;
        }
        
        /* Checklist */
        .checklist {
            list-style: none;
            padding: 0;
        }
        
        .checklist li {
            padding: 12px 0;
            padding-left: 35px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .checklist li::before {
            content: '‚òê';
            position: absolute;
            left: 0;
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        .checklist li.required::before {
            content: '‚ñ†';
            color: var(--primary);
        }
        
        .checklist li.optional::before {
            content: '‚óã';
            color: var(--text-muted);
        }
        
        /* Decision Tree */
        .decision-tree {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
        }
        
        .decision-node {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }
        
        .decision-node.branch {
            margin-left: 30px;
            border-left-color: var(--secondary);
        }
        
        .decision-node.action {
            margin-left: 60px;
            border-left-color: var(--success);
            background: rgba(72, 187, 120, 0.1);
        }
        
        .decision-question {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .decision-answer {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Alert Box */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .alert-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }
        
        .alert.info {
            background: rgba(99, 179, 237, 0.1);
            border: 1px solid rgba(99, 179, 237, 0.3);
        }
        
        .alert.warning {
            background: rgba(237, 137, 54, 0.1);
            border: 1px solid rgba(237, 137, 54, 0.3);
        }
        
        .alert.success {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid rgba(72, 187, 120, 0.3);
        }
        
        /* Schema Output */
        .schema-box {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .schema-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .schema-field {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
        }
        
        .schema-field-name {
            color: var(--text-secondary);
        }
        
        .schema-field-type {
            color: var(--secondary);
            font-family: monospace;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
            margin-top: 50px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .workflow-container {
                padding: 20px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üî¨ E2I Causal Validation Protocol</h1>
            <p class="subtitle">Integrated Testing Framework for Causal Impact Agent ‚Ä¢ DoWhy Refutation Suite</p>
            <span class="version-badge">Protocol v1.0 ‚Ä¢ December 2025</span>
        </header>
        
        <!-- Executive Summary -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">üìã</span> Executive Summary</h2>
                <p>Three-tier validation strategy for defensible causal claims in pharmaceutical commercial operations</p>
            </div>
            
            <div class="card">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Testing causal inference accuracy is inherently challenging because ground truth is rarely known. This protocol integrates three complementary validation techniques with the existing Causal Impact agent's 5-node workflow, prioritizing automated refutation tests for scalability while leveraging expert review and synthetic benchmarks at strategic checkpoints.
                </p>
                
                <div class="alert info">
                    <span class="alert-icon">üí°</span>
                    <div>
                        <strong>Key Insight:</strong> Your architecture already includes a Refutation node in the 5-node workflow. This protocol extends that foundation with specific test configurations, thresholds, and integration points for the other two validation techniques.
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 5-Node Workflow Diagram -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">üîÑ</span> Causal Impact Agent: 5-Node Workflow</h2>
                <p>Validation integration points within the existing hybrid agent architecture</p>
            </div>
            
            <div class="workflow-container">
                <div class="workflow-nodes">
                    <div class="workflow-node">
                        <div class="node-circle graph">üîó</div>
                        <div class="node-name">GraphBuilder</div>
                        <div class="node-desc">DAG construction<br>NetworkX</div>
                    </div>
                    
                    <span class="workflow-arrow">‚Üí</span>
                    
                    <div class="workflow-node">
                        <div class="node-circle estimation">üìä</div>
                        <div class="node-name">Estimation</div>
                        <div class="node-desc">Effect calculation<br>DoWhy/EconML</div>
                    </div>
                    
                    <span class="workflow-arrow">‚Üí</span>
                    
                    <div class="workflow-node">
                        <div class="node-badge">PRIMARY</div>
                        <div class="node-circle refutation">üß™</div>
                        <div class="node-name">Refutation</div>
                        <div class="node-desc">Robustness tests<br>DoWhy refuters</div>
                    </div>
                    
                    <span class="workflow-arrow">‚Üí</span>
                    
                    <div class="workflow-node">
                        <div class="node-circle sensitivity">üìà</div>
                        <div class="node-name">Sensitivity</div>
                        <div class="node-desc">Confound bounds<br>E-value analysis</div>
                    </div>
                    
                    <span class="workflow-arrow">‚Üí</span>
                    
                    <div class="workflow-node">
                        <div class="node-circle interpretation">üí¨</div>
                        <div class="node-name">Interpretation</div>
                        <div class="node-desc">LLM narrative<br>Claude generation</div>
                    </div>
                </div>
            </div>
            
            <div class="alert warning">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Critical Gate:</strong> The Refutation node acts as a quality gate. If refutation tests fail, the workflow should NOT proceed to Interpretation. Failed estimates are logged to <code>ml_experiments</code> with <code>status='refutation_failed'</code>.
                </div>
            </div>
        </section>
        
        <!-- Three Techniques Priority -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">üéØ</span> Validation Technique Prioritization</h2>
                <p>Ordered by implementation priority and integration depth</p>
            </div>
            
            <div class="priority-section">
                <!-- Primary -->
                <div class="priority-card primary">
                    <div class="priority-rank primary">1</div>
                    <h3 class="priority-title">Robustness Tests (DoWhy Refutation)</h3>
                    <div class="priority-when">üìç <strong>When:</strong> Every causal estimate, automated</div>
                    <div class="priority-integration">
                        <strong>Integration Point:</strong> Node 3 (Refutation)<br>
                        <strong>Implementation:</strong> <code>causal_engine/refutation.py</code><br>
                        <strong>Storage:</strong> <code>causal_validations</code> table
                    </div>
                </div>
                
                <!-- Secondary -->
                <div class="priority-card secondary">
                    <div class="priority-rank secondary">2</div>
                    <h3 class="priority-title">Expert Review (DAG Plausibility)</h3>
                    <div class="priority-when">üìç <strong>When:</strong> New DAG construction, quarterly review</div>
                    <div class="priority-integration">
                        <strong>Integration Point:</strong> Node 1 (GraphBuilder)<br>
                        <strong>Implementation:</strong> <code>causal_engine/validators.py</code><br>
                        <strong>Storage:</strong> <code>expert_reviews</code> table
                    </div>
                </div>
                
                <!-- Tertiary -->
                <div class="priority-card tertiary">
                    <div class="priority-rank tertiary">3</div>
                    <h3 class="priority-title">Synthetic Benchmarks (CI/CD)</h3>
                    <div class="priority-when">üìç <strong>When:</strong> Test suite, regression checks</div>
                    <div class="priority-integration">
                        <strong>Integration Point:</strong> Pre-deployment<br>
                        <strong>Implementation:</strong> <code>tests/synthetic/</code><br>
                        <strong>Storage:</strong> Test artifacts in CI
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Primary: DoWhy Refutation Tests -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">üß™</span> Primary: DoWhy Refutation Test Suite</h2>
                <p>Automated robustness tests executed on every causal estimate</p>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon refutation">‚ö°</div>
                    <div>
                        <div class="card-title">Refutation Test Configuration</div>
                        <div class="card-subtitle">causal_engine/refutation.py ‚Ä¢ 4 standard tests + 1 composite</div>
                    </div>
                </div>
                
                <table class="tests-table">
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>DoWhy Method</th>
                            <th>What It Tests</th>
                            <th>Pass Criteria</th>
                            <th>E2I Default</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="test-name">Placebo Treatment</td>
                            <td><code>placebo_treatment_refuter</code></td>
                            <td>Replace treatment with random noise ‚Üí effect should disappear</td>
                            <td>p-value > 0.05 for null effect</td>
                            <td><span class="pass-indicator pass">Required</span></td>
                        </tr>
                        <tr>
                            <td class="test-name">Random Common Cause</td>
                            <td><code>add_unobserved_common_cause</code></td>
                            <td>Add fake confounder ‚Üí effect should remain stable</td>
                            <td>Œî effect < 20% of original</td>
                            <td><span class="pass-indicator pass">Required</span></td>
                        </tr>
                        <tr>
                            <td class="test-name">Data Subset</td>
                            <td><code>data_subset_refuter</code></td>
                            <td>Test on random subsamples ‚Üí effect should be consistent</td>
                            <td>Effect within 95% CI across 10 subsets</td>
                            <td><span class="pass-indicator pass">Required</span></td>
                        </tr>
                        <tr>
                            <td class="test-name">Bootstrap Variance</td>
                            <td><code>bootstrap_refuter</code></td>
                            <td>Bootstrap resampling ‚Üí estimate variance</td>
                            <td>CI width < 50% of effect size</td>
                            <td><span class="pass-indicator warn">Recommended</span></td>
                        </tr>
                        <tr>
                            <td class="test-name">Sensitivity (E-value)</td>
                            <td><code>sensitivity_e_value</code></td>
                            <td>How strong would unmeasured confounding need to be?</td>
                            <td>E-value > 2.0</td>
                            <td><span class="pass-indicator pass">Required</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon primary">üêç</div>
                    <div>
                        <div class="card-title">Implementation: RefutationRunner</div>
                        <div class="card-subtitle">Integration with Causal Impact agent's Node 3</div>
                    </div>
                </div>
                
                <div class="code-block">
<span class="comment"># causal_engine/refutation.py</span>
<span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass
<span class="keyword">from</span> typing <span class="keyword">import</span> List, Dict, Optional
<span class="keyword">from</span> enum <span class="keyword">import</span> Enum
<span class="keyword">import</span> dowhy

<span class="keyword">class</span> <span class="class">RefutationStatus</span>(Enum):
    PASSED = <span class="string">"passed"</span>
    FAILED = <span class="string">"failed"</span>
    WARNING = <span class="string">"warning"</span>
    SKIPPED = <span class="string">"skipped"</span>

@dataclass
<span class="keyword">class</span> <span class="class">RefutationResult</span>:
    test_name: str
    status: RefutationStatus
    original_effect: float
    refuted_effect: float
    p_value: Optional[float]
    delta_percent: float
    details: Dict

@dataclass
<span class="keyword">class</span> <span class="class">RefutationSuite</span>:
    <span class="string">"""Aggregate result of all refutation tests"""</span>
    passed: bool
    confidence_score: float  <span class="comment"># 0-1 composite score</span>
    tests: List[RefutationResult]
    gate_decision: str  <span class="comment"># "proceed" | "block" | "review"</span>

<span class="keyword">class</span> <span class="class">RefutationRunner</span>:
    <span class="string">"""Executes DoWhy refutation tests for Causal Impact agent"""</span>
    
    DEFAULT_CONFIG = {
        <span class="string">"placebo_treatment"</span>: {<span class="string">"enabled"</span>: True, <span class="string">"num_simulations"</span>: <span class="number">100</span>},
        <span class="string">"random_common_cause"</span>: {<span class="string">"enabled"</span>: True, <span class="string">"effect_strength"</span>: <span class="number">0.1</span>},
        <span class="string">"data_subset"</span>: {<span class="string">"enabled"</span>: True, <span class="string">"subset_fraction"</span>: <span class="number">0.8</span>, <span class="string">"num_subsets"</span>: <span class="number">10</span>},
        <span class="string">"bootstrap"</span>: {<span class="string">"enabled"</span>: True, <span class="string">"num_bootstraps"</span>: <span class="number">500</span>},
        <span class="string">"sensitivity"</span>: {<span class="string">"enabled"</span>: True, <span class="string">"e_value_threshold"</span>: <span class="number">2.0</span>},
    }
    
    PASS_THRESHOLDS = {
        <span class="string">"placebo_p_value"</span>: <span class="number">0.05</span>,      <span class="comment"># p > 0.05 means null effect confirmed</span>
        <span class="string">"common_cause_delta"</span>: <span class="number">0.20</span>,   <span class="comment"># Œî < 20% of original</span>
        <span class="string">"subset_ci_coverage"</span>: <span class="number">0.80</span>,   <span class="comment"># 80% of subsets within CI</span>
        <span class="string">"bootstrap_ci_ratio"</span>: <span class="number">0.50</span>,   <span class="comment"># CI width < 50% of effect</span>
        <span class="string">"e_value_min"</span>: <span class="number">2.0</span>,           <span class="comment"># E-value must exceed 2.0</span>
    }
    
    <span class="keyword">def</span> <span class="function">run_suite</span>(self, causal_model, estimate) -> RefutationSuite:
        <span class="string">"""Execute all refutation tests and return aggregate result"""</span>
        results = []
        
        <span class="comment"># 1. Placebo Treatment Test</span>
        <span class="keyword">if</span> self.config[<span class="string">"placebo_treatment"</span>][<span class="string">"enabled"</span>]:
            results.append(self._run_placebo(causal_model, estimate))
        
        <span class="comment"># 2. Random Common Cause Test</span>
        <span class="keyword">if</span> self.config[<span class="string">"random_common_cause"</span>][<span class="string">"enabled"</span>]:
            results.append(self._run_common_cause(causal_model, estimate))
        
        <span class="comment"># 3. Data Subset Test</span>
        <span class="keyword">if</span> self.config[<span class="string">"data_subset"</span>][<span class="string">"enabled"</span>]:
            results.append(self._run_subset(causal_model, estimate))
        
        <span class="comment"># 4. Bootstrap Test</span>
        <span class="keyword">if</span> self.config[<span class="string">"bootstrap"</span>][<span class="string">"enabled"</span>]:
            results.append(self._run_bootstrap(causal_model, estimate))
        
        <span class="comment"># 5. Sensitivity Analysis (E-value)</span>
        <span class="keyword">if</span> self.config[<span class="string">"sensitivity"</span>][<span class="string">"enabled"</span>]:
            results.append(self._run_sensitivity(causal_model, estimate))
        
        <span class="keyword">return</span> self._aggregate_results(results)
    
    <span class="keyword">def</span> <span class="function">_aggregate_results</span>(self, results: List[RefutationResult]) -> RefutationSuite:
        <span class="string">"""Compute composite score and gate decision"""</span>
        required_tests = [<span class="string">"placebo_treatment"</span>, <span class="string">"random_common_cause"</span>, 
                          <span class="string">"data_subset"</span>, <span class="string">"sensitivity"</span>]
        
        <span class="comment"># Check required tests</span>
        required_passed = all(
            r.status == RefutationStatus.PASSED 
            <span class="keyword">for</span> r <span class="keyword">in</span> results 
            <span class="keyword">if</span> r.test_name <span class="keyword">in</span> required_tests
        )
        
        <span class="comment"># Compute confidence score (weighted average)</span>
        weights = {<span class="string">"placebo"</span>: <span class="number">0.3</span>, <span class="string">"common_cause"</span>: <span class="number">0.25</span>, 
                   <span class="string">"subset"</span>: <span class="number">0.2</span>, <span class="string">"bootstrap"</span>: <span class="number">0.1</span>, <span class="string">"sensitivity"</span>: <span class="number">0.15</span>}
        confidence = sum(
            weights.get(r.test_name.split(<span class="string">"_"</span>)[<span class="number">0</span>], <span class="number">0.1</span>) 
            * (<span class="number">1.0</span> <span class="keyword">if</span> r.status == RefutationStatus.PASSED <span class="keyword">else</span> <span class="number">0.0</span>)
            <span class="keyword">for</span> r <span class="keyword">in</span> results
        )
        
        <span class="comment"># Gate decision logic</span>
        <span class="keyword">if</span> required_passed <span class="keyword">and</span> confidence >= <span class="number">0.7</span>:
            gate = <span class="string">"proceed"</span>
        <span class="keyword">elif</span> confidence >= <span class="number">0.5</span>:
            gate = <span class="string">"review"</span>  <span class="comment"># Requires expert review before use</span>
        <span class="keyword">else</span>:
            gate = <span class="string">"block"</span>
        
        <span class="keyword">return</span> RefutationSuite(
            passed=required_passed,
            confidence_score=confidence,
            tests=results,
            gate_decision=gate
        )
                </div>
            </div>
            
            <!-- Output Schema -->
            <div class="schema-box">
                <div class="schema-title">üì¶ Output: causal_validations Table Schema</div>
                <div class="schema-field">
                    <span class="schema-field-name">validation_id</span>
                    <span class="schema-field-type">UUID PRIMARY KEY</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">estimate_id</span>
                    <span class="schema-field-type">UUID FK ‚Üí causal_estimates</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">test_type</span>
                    <span class="schema-field-type">ENUM('placebo', 'common_cause', 'subset', 'bootstrap', 'sensitivity')</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">status</span>
                    <span class="schema-field-type">ENUM('passed', 'failed', 'warning', 'skipped')</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">original_effect</span>
                    <span class="schema-field-type">DECIMAL(10,6)</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">refuted_effect</span>
                    <span class="schema-field-type">DECIMAL(10,6)</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">p_value</span>
                    <span class="schema-field-type">DECIMAL(5,4) NULLABLE</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">confidence_score</span>
                    <span class="schema-field-type">DECIMAL(3,2) CHECK(0-1)</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">gate_decision</span>
                    <span class="schema-field-type">ENUM('proceed', 'review', 'block')</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">details_json</span>
                    <span class="schema-field-type">JSONB</span>
                </div>
                <div class="schema-field">
                    <span class="schema-field-name">created_at</span>
                    <span class="schema-field-type">TIMESTAMPTZ DEFAULT now()</span>
                </div>
            </div>
        </section>
        
        <!-- Secondary: Expert Review -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">üë®‚Äç‚öïÔ∏è</span> Secondary: Expert Review Protocol</h2>
                <p>Domain expert validation for DAG construction and structural assumptions</p>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon secondary">üîç</div>
                    <div>
                        <div class="card-title">When Expert Review is Required</div>
                        <div class="card-subtitle">Integration with GraphBuilder node</div>
                    </div>
                </div>
                
                <div class="decision-tree">
                    <div class="decision-node">
                        <div class="decision-question">Is this a NEW causal graph (not previously validated)?</div>
                        <div class="decision-answer">Check <code>expert_reviews</code> table for existing approval</div>
                    </div>
                    
                    <div class="decision-node branch">
                        <div class="decision-question">YES ‚Üí Expert review REQUIRED before production use</div>
                    </div>
                    
                    <div class="decision-node action">
                        <div class="decision-answer">
                            ‚úÖ Trigger DAG Review workflow<br>
                            ‚úÖ Generate review checklist<br>
                            ‚úÖ Block Estimation node until approved
                        </div>
                    </div>
                    
                    <div class="decision-node branch">
                        <div class="decision-question">NO ‚Üí Has the underlying data source changed significantly?</div>
                    </div>
                    
                    <div class="decision-node action">
                        <div class="decision-answer">
                            ‚ö†Ô∏è Flag for quarterly review cycle<br>
                            ‚úÖ Allow automated refutation to proceed
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon secondary">üìã</div>
                    <div>
                        <div class="card-title">DAG Review Checklist</div>
                        <div class="card-subtitle">Required sign-off from Commercial Ops / Medical Affairs</div>
                    </div>
                </div>
                
                <ul class="checklist">
                    <li class="required"><strong>Confounder completeness:</strong> Are all known confounders included? (e.g., seasonality, channel mix, regional variations)</li>
                    <li class="required"><strong>Edge direction plausibility:</strong> Do causal arrows reflect domain knowledge about mechanism?</li>
                    <li class="required"><strong>No forbidden edges:</strong> Are there edges that would violate known constraints? (e.g., future ‚Üí past)</li>
                    <li class="required"><strong>Mediator identification:</strong> Are intermediate variables correctly positioned?</li>
                    <li class="optional"><strong>Instrumental variables:</strong> Are proposed IVs genuinely exogenous?</li>
                    <li class="optional"><strong>Selection bias consideration:</strong> Could there be selection effects not modeled?</li>
                    <li class="required"><strong>SUTVA plausibility:</strong> Is the "no interference" assumption reasonable for this analysis?</li>
                </ul>
                
                <div class="alert success" style="margin-top: 20px;">
                    <span class="alert-icon">‚úÖ</span>
                    <div>
                        <strong>Approval stored in:</strong> <code>expert_reviews</code> table with <code>reviewer_id</code>, <code>approval_date</code>, <code>dag_version_hash</code>, and <code>comments_json</code>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Tertiary: Synthetic Benchmarks -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">üß¨</span> Tertiary: Synthetic Benchmark Suite</h2>
                <p>Known ground-truth datasets for CI/CD regression testing</p>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon tertiary">üî¨</div>
                    <div>
                        <div class="card-title">Synthetic Dataset Specifications</div>
                        <div class="card-subtitle">tests/synthetic/ ‚Ä¢ 3 benchmark scenarios</div>
                    </div>
                </div>
                
                <table class="tests-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>True ATE</th>
                            <th>Confounding</th>
                            <th>N</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="test-name">simple_linear</td>
                            <td><code>+0.50</code></td>
                            <td>None</td>
                            <td>10,000</td>
                            <td>Baseline sanity check</td>
                        </tr>
                        <tr>
                            <td class="test-name">confounded_moderate</td>
                            <td><code>+0.30</code></td>
                            <td>1 observed, strength=0.4</td>
                            <td>10,000</td>
                            <td>Adjustment recovery test</td>
                        </tr>
                        <tr>
                            <td class="test-name">heterogeneous_cate</td>
                            <td><code>varies by segment</code></td>
                            <td>2 observed</td>
                            <td>50,000</td>
                            <td>CATE estimation accuracy</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="code-block" style="margin-top: 20px;">
<span class="comment"># tests/synthetic/conftest.py</span>
<span class="keyword">import</span> pytest
<span class="keyword">import</span> numpy <span class="keyword">as</span> np

@pytest.fixture
<span class="keyword">def</span> <span class="function">synthetic_confounded</span>():
    <span class="string">"""Generate dataset with known causal effect = 0.30"""</span>
    np.random.seed(<span class="number">42</span>)
    n = <span class="number">10000</span>
    
    <span class="comment"># Confounder</span>
    C = np.random.normal(<span class="number">0</span>, <span class="number">1</span>, n)
    
    <span class="comment"># Treatment influenced by confounder</span>
    T = (np.random.uniform(<span class="number">0</span>, <span class="number">1</span>, n) < expit(<span class="number">0.4</span> * C)).astype(int)
    
    <span class="comment"># Outcome: TRUE EFFECT = 0.30</span>
    Y = <span class="number">0.30</span> * T + <span class="number">0.4</span> * C + np.random.normal(<span class="number">0</span>, <span class="number">0.5</span>, n)
    
    <span class="keyword">return</span> {
        <span class="string">"data"</span>: pd.DataFrame({<span class="string">"T"</span>: T, <span class="string">"Y"</span>: Y, <span class="string">"C"</span>: C}),
        <span class="string">"true_ate"</span>: <span class="number">0.30</span>,
        <span class="string">"tolerance"</span>: <span class="number">0.05</span>  <span class="comment"># Accept estimates within ¬±0.05</span>
    }

<span class="keyword">def</span> <span class="function">test_confounded_recovery</span>(synthetic_confounded, causal_impact_agent):
    <span class="string">"""CI/CD test: Can we recover true effect after adjustment?"""</span>
    result = causal_impact_agent.estimate(
        data=synthetic_confounded[<span class="string">"data"</span>],
        treatment=<span class="string">"T"</span>,
        outcome=<span class="string">"Y"</span>,
        confounders=[<span class="string">"C"</span>]
    )
    
    <span class="keyword">assert</span> abs(result.ate - synthetic_confounded[<span class="string">"true_ate"</span>]) < synthetic_confounded[<span class="string">"tolerance"</span>], \
        f<span class="string">"Estimated ATE {result.ate} not within tolerance of true {synthetic_confounded['true_ate']}"</span>
                </div>
            </div>
        </section>
        
        <!-- Integrated Workflow -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">üîó</span> Integrated Validation Workflow</h2>
                <p>How the three techniques combine in the experimental learning cycle</p>
            </div>
            
            <div class="card">
                <div class="integration-flow">
                    <div class="flow-stage">
                        <div class="flow-stage-icon">üß™</div>
                        <div class="flow-stage-title">Experiment Designer</div>
                        <div class="flow-stage-desc">Designs A/B test using past learnings from ExperimentKnowledgeStore</div>
                    </div>
                    
                    <div class="flow-stage">
                        <div class="flow-stage-icon">‚ö°</div>
                        <div class="flow-stage-title">Causal Impact Agent</div>
                        <div class="flow-stage-desc">5-node workflow with integrated refutation gate</div>
                    </div>
                    
                    <div class="flow-stage">
                        <div class="flow-stage-icon">üìö</div>
                        <div class="flow-stage-title">Feedback Learner</div>
                        <div class="flow-stage-desc">Stores validation outcomes for future design context</div>
                    </div>
                </div>
                
                <div class="flow-arrow-down">‚¨áÔ∏è</div>
                
                <div class="alert info">
                    <span class="alert-icon">üîÑ</span>
                    <div>
                        <strong>Learning Loop:</strong> When refutation tests fail, the Feedback Learner records the failure pattern. Experiment Designer then uses this knowledge to avoid similar designs (e.g., "insufficient sample size for detecting effects < 0.1").
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon primary">üìä</div>
                    <div>
                        <div class="card-title">Validation Decision Matrix</div>
                        <div class="card-subtitle">Action based on validation results</div>
                    </div>
                </div>
                
                <table class="tests-table">
                    <thead>
                        <tr>
                            <th>Refutation Suite</th>
                            <th>Expert Approval</th>
                            <th>Synthetic Pass</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="pass-indicator pass">PASS</span></td>
                            <td><span class="pass-indicator pass">YES</span></td>
                            <td><span class="pass-indicator pass">PASS</span></td>
                            <td>‚úÖ Production-ready ‚Ä¢ Full confidence</td>
                        </tr>
                        <tr>
                            <td><span class="pass-indicator pass">PASS</span></td>
                            <td><span class="pass-indicator pass">YES</span></td>
                            <td><span class="pass-indicator warn">N/A</span></td>
                            <td>‚úÖ Production-ready ‚Ä¢ Normal operation</td>
                        </tr>
                        <tr>
                            <td><span class="pass-indicator pass">PASS</span></td>
                            <td><span class="pass-indicator warn">PENDING</span></td>
                            <td>‚Äî</td>
                            <td>‚ö†Ô∏è Internal use only ‚Ä¢ Queue for expert review</td>
                        </tr>
                        <tr>
                            <td><span class="pass-indicator warn">PARTIAL</span></td>
                            <td><span class="pass-indicator pass">YES</span></td>
                            <td>‚Äî</td>
                            <td>‚ö†Ô∏è Report with caveats ‚Ä¢ Widen confidence intervals</td>
                        </tr>
                        <tr>
                            <td><span class="pass-indicator fail">FAIL</span></td>
                            <td>‚Äî</td>
                            <td>‚Äî</td>
                            <td>üö´ Block ‚Ä¢ Do not report ‚Ä¢ Log to Feedback Learner</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Implementation Checklist -->
        <section class="section">
            <div class="section-header">
                <h2><span class="icon">‚úÖ</span> Implementation Checklist</h2>
                <p>Steps to integrate this protocol into E2I V3</p>
            </div>
            
            <div class="card">
                <ul class="checklist">
                    <li class="required"><strong>Phase 1:</strong> Extend <code>causal_engine/refutation.py</code> with RefutationRunner class</li>
                    <li class="required"><strong>Phase 1:</strong> Add <code>causal_validations</code> table migration (schema above)</li>
                    <li class="required"><strong>Phase 1:</strong> Wire Refutation node to call <code>run_suite()</code> and gate on result</li>
                    <li class="required"><strong>Phase 1:</strong> Update Causal Impact agent contract to emit <code>ValidationSuite</code> output</li>
                    <li class="optional"><strong>Phase 2:</strong> Create <code>expert_reviews</code> table and admin UI</li>
                    <li class="optional"><strong>Phase 2:</strong> Add DAG version hashing to GraphBuilder node</li>
                    <li class="optional"><strong>Phase 3:</strong> Implement <code>tests/synthetic/</code> benchmark suite</li>
                    <li class="optional"><strong>Phase 3:</strong> Add synthetic tests to CI/CD pipeline</li>
                    <li class="optional"><strong>Phase 4:</strong> Connect Feedback Learner to validation outcomes</li>
                    <li class="optional"><strong>Phase 4:</strong> Build ExperimentKnowledgeStore query for past failures</li>
                </ul>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="footer">
            <p>E2I Causal Validation Protocol v1.0 ‚Ä¢ December 2025</p>
            <p style="margin-top: 8px; color: var(--text-muted);">
                Integrates with: Causal Impact Agent (Tier 2) ‚Ä¢ Experiment Designer (Tier 3) ‚Ä¢ Feedback Learner (Tier 5)
            </p>
        </footer>
    </div>
</body>
</html>
