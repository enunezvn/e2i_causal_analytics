{
  "schema_version": "1.2",
  "created_date": "2025-12-13",
  "last_updated": "2025-12-20",
  "purpose": "Comprehensive Data Schema for E2I Causal Analytics Dashboard",
  "total_tables": 55,
  "total_views": 63,
  "total_enums": 41,
  "total_functions_documented": 32,
  "total_records_expected": 1500000,

  "version_history": {
    "1.2": {
      "date": "2025-12-20",
      "changes": [
        "Phase 0: Created shap_analysis_type ENUM for realtime SHAP audit",
        "Phase 1A - Memory System: Added 5 tables (cognitive_cycles, episodic_memories, procedural_memories, semantic_memory_cache, memory_statistics)",
        "Phase 1A - Memory System: Added 7 ENUMs (cognitive_phase, procedure_type, memory_event_type, memory_outcome_type, memory_importance, memory_type, e2i_agent_name)",
        "Phase 1A - Memory System: Added 3 functions (get_memory_e2i_ids, get_memory_entity_context, search_episodic_memory)",
        "Phase 1B - DSPy Integration: Added 5 tables (dspy_optimization_runs, dspy_agent_training_signals, dspy_cognitive_context_history, dspy_prompt_versions, learning_signals)",
        "Phase 1B - DSPy Integration: Added 3 ENUMs (dspy_optimization_phase, optimization_status, learning_signal_type)",
        "Phase 1B - DSPy Integration: Added 2 functions (get_dspy_agent_metrics, get_dspy_training_examples)",
        "Phase 1C - Feature Store: Added 4 tables (feature_groups, features, feature_values, ml_feature_store)",
        "Phase 1C - Feature Store: Added 3 ENUMs (feature_value_type, feature_freshness_status, data_split_type)",
        "Phase 1C - Feature Store: Added 2 views (feature_values_latest, feature_freshness_monitor)",
        "Phase 1C - Feature Store: Added 4 functions (get_entity_features, update_feature_freshness, 2 triggers)",
        "Phase 1D - Audit Chain: Added 2 tables (audit_chain_entries, audit_chain_verification_log)",
        "Phase 1D - Audit Chain: Added 2 views (v_audit_chain_summary, v_audit_chain_daily_stats)",
        "Phase 1D - Audit Chain: Added 2 functions (verify_chain_integrity, verify_all_chains)",
        "Phase 2 - Remaining Entities: Added 1 table (investigation_hops), 1 view (v_causal_validation_chain)",
        "Phase 2 - Remaining Entities: Added 17 ENUMs (agent_name_enum, agent_name_type_v2, agent_tier_enum, brand_type, composition_status, routing_pattern, tool_category, dependency_type, twin_type, fidelity_grade, simulation_status, simulation_recommendation, prediction_type, model_stage_enum, deployment_status_enum, split_strategy_type, shap_analysis_type)",
        "Final Coverage: Tables 55/55 (100%), ENUMs 41/41 (100%), Views 63/63 (100%), Functions 32/51 (62.7%)"
      ]
    },
    "1.1": {
      "date": "2025-12-13",
      "changes": [
        "Added causal_validations entity for DoWhy refutation tests",
        "Added expert_reviews entity for DAG approval tracking",
        "Updated agent_activity to 18-agent architecture",
        "Added 4 validation ENUMs: refutation_test_type, validation_status, gate_decision, expert_review_type",
        "Added validation_thresholds configuration",
        "Table count: 26 → 28"
      ]
    },
    "1.0": {
      "date": "2025-11-14",
      "changes": ["Initial schema with 7 core entities"]
    }
  },

  "memory_system_entities": {
    "_comment": "V1.2 NEW: Tri-Memory Architecture for Cognitive Workflows",

    "cognitive_cycles": {
      "description": "Tracks 4-phase cognitive workflow: Summarizer → Investigator → Agent → Reflector",
      "primary_key": "cycle_id",
      "introduced_version": "1.2",
      "integration_point": "Memory system cognitive workflow orchestration",
      "fields": {
        "cycle_id": "uuid",
        "session_id": "uuid",
        "user_id": "text",
        "query_text": "text",
        "query_embedding": "vector(1536)",
        "current_phase": "enum[summarizer, investigator, agent, reflector]",
        "phase_started_at": "timestamp with time zone",
        "summarizer_output": "jsonb",
        "summarizer_duration_ms": "integer",
        "summarizer_token_count": "integer",
        "investigator_output": "jsonb",
        "investigator_duration_ms": "integer",
        "investigator_token_count": "integer",
        "investigator_tools_used": "text[]",
        "investigator_sources_count": "integer",
        "agent_output": "jsonb",
        "agent_duration_ms": "integer",
        "agent_token_count": "integer",
        "agent_name": "text",
        "agent_confidence": "real",
        "reflector_output": "jsonb",
        "reflector_duration_ms": "integer",
        "reflector_token_count": "integer",
        "reflector_quality_score": "real",
        "reflector_improvement_suggestions": "text[]",
        "total_duration_ms": "integer",
        "total_token_count": "integer",
        "final_response": "text",
        "user_feedback_score": "integer",
        "user_feedback_text": "text",
        "error_phase": "text",
        "error_message": "text",
        "created_at": "timestamp with time zone",
        "completed_at": "timestamp with time zone"
      },
      "indexes": [
        "session_id",
        "user_id",
        "current_phase",
        "created_at DESC",
        "query_embedding (ivfflat vector_cosine_ops)"
      ]
    },

    "episodic_memories": {
      "description": "Event-based memory storage for user queries, agent actions, and system events",
      "primary_key": "memory_id",
      "introduced_version": "1.2",
      "integration_point": "Memory backend for contextual retrieval",
      "fields": {
        "memory_id": "uuid",
        "session_id": "uuid",
        "user_id": "text",
        "event_type": "enum[user_query, agent_action, system_event, feedback, error, causal_discovery, trigger_generated, experiment_completed]",
        "event_timestamp": "timestamp with time zone",
        "content": "text",
        "content_embedding": "vector(1536)",
        "metadata": "jsonb",
        "importance_score": "real",
        "importance_level": "enum[critical, high, medium, low, routine]",
        "outcome": "enum[success, partial_success, failure, pending, escalated]",
        "agent_name": "text",
        "brand": "text",
        "kpi_impacted": "text[]",
        "entities_involved": "jsonb",
        "retrieval_count": "integer",
        "last_retrieved_at": "timestamp with time zone",
        "expires_at": "timestamp with time zone",
        "is_archived": "boolean",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": [
        "session_id",
        "user_id",
        "event_type",
        "importance_level",
        "brand",
        "created_at DESC",
        "content_embedding (ivfflat vector_cosine_ops)"
      ]
    },

    "procedural_memories": {
      "description": "Learned tool sequences and query patterns for optimization",
      "primary_key": "procedure_id",
      "introduced_version": "1.2",
      "integration_point": "Feedback Learner agent pattern discovery",
      "fields": {
        "procedure_id": "uuid",
        "procedure_type": "enum[tool_sequence, query_pattern, error_recovery, optimization, causal_chain_traversal]",
        "name": "text",
        "description": "text",
        "trigger_conditions": "jsonb",
        "trigger_embedding": "vector(1536)",
        "action_sequence": "jsonb",
        "expected_outcome": "text",
        "success_rate": "real",
        "execution_count": "integer",
        "avg_duration_ms": "integer",
        "last_executed_at": "timestamp with time zone",
        "learned_from_episodes": "uuid[]",
        "confidence_score": "real",
        "is_active": "boolean",
        "version": "integer",
        "supersedes_procedure_id": "uuid",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": [
        "procedure_type",
        "is_active",
        "success_rate DESC",
        "trigger_embedding (ivfflat vector_cosine_ops)"
      ]
    },

    "semantic_memory_cache": {
      "description": "Cache for FalkorDB graph database synchronization",
      "primary_key": "cache_id",
      "introduced_version": "1.2",
      "integration_point": "FalkorDB semantic memory layer",
      "fields": {
        "cache_id": "uuid",
        "graph_node_id": "text",
        "node_type": "text",
        "node_label": "text",
        "properties": "jsonb",
        "property_embedding": "vector(1536)",
        "relationships": "jsonb",
        "relationship_count": "integer",
        "centrality_score": "real",
        "community_id": "text",
        "last_accessed_at": "timestamp with time zone",
        "access_count": "integer",
        "sync_status": "enum[synced, pending, conflict, error]",
        "last_synced_at": "timestamp with time zone",
        "falkordb_version": "integer",
        "pg_version": "integer",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": [
        "graph_node_id",
        "node_type",
        "sync_status",
        "last_accessed_at DESC",
        "property_embedding (ivfflat vector_cosine_ops)"
      ]
    },

    "memory_statistics": {
      "description": "Performance monitoring and analytics for memory operations",
      "primary_key": "stat_id",
      "introduced_version": "1.2",
      "integration_point": "Memory system observability",
      "fields": {
        "stat_id": "uuid",
        "stat_date": "date",
        "stat_hour": "integer",
        "memory_type": "enum[episodic, procedural, semantic, working]",
        "operation_type": "enum[store, retrieve, update, delete, consolidate, prune]",
        "operation_count": "integer",
        "success_count": "integer",
        "failure_count": "integer",
        "avg_latency_ms": "real",
        "p50_latency_ms": "real",
        "p95_latency_ms": "real",
        "p99_latency_ms": "real",
        "total_bytes_processed": "bigint",
        "cache_hit_rate": "real",
        "embedding_generation_count": "integer",
        "embedding_avg_latency_ms": "real",
        "unique_users": "integer",
        "unique_sessions": "integer",
        "created_at": "timestamp with time zone"
      },
      "indexes": [
        ["stat_date", "stat_hour"],
        "memory_type",
        "operation_type"
      ]
    }
  },

  "memory_system_functions": {
    "_comment": "V1.2 NEW: Memory system utility functions",

    "get_memory_e2i_ids": {
      "description": "Extract E2I entity IDs (patient_id, hcp_id, brand) from memory metadata",
      "parameters": ["p_memory_id UUID"],
      "returns": "TABLE(patient_id TEXT, hcp_id TEXT, brand TEXT, kpi_name TEXT)",
      "introduced_version": "1.2"
    },

    "get_memory_entity_context": {
      "description": "Get full entity context for a memory including related entities",
      "parameters": ["p_memory_id UUID"],
      "returns": "TABLE(entity_type TEXT, entity_id TEXT, entity_name TEXT, relationship TEXT)",
      "introduced_version": "1.2"
    },

    "search_episodic_memory": {
      "description": "Semantic search across episodic memories with filters",
      "parameters": [
        "query_embedding VECTOR(1536)",
        "p_user_id TEXT DEFAULT NULL",
        "p_event_types TEXT[] DEFAULT NULL",
        "p_brands TEXT[] DEFAULT NULL",
        "p_min_importance REAL DEFAULT 0.0",
        "p_limit INTEGER DEFAULT 10",
        "p_similarity_threshold REAL DEFAULT 0.7"
      ],
      "returns": "TABLE(memory_id UUID, content TEXT, similarity REAL, event_type TEXT, importance_score REAL, metadata JSONB)",
      "introduced_version": "1.2"
    }
  },

  "memory_enums": {
    "_comment": "V1.2 NEW: Memory system ENUMs",
    "cognitive_phase": {
      "description": "4-phase cognitive workflow stages",
      "values": ["summarizer", "investigator", "agent", "reflector"]
    },
    "procedure_type": {
      "description": "Types of procedural memory patterns",
      "values": ["tool_sequence", "query_pattern", "error_recovery", "optimization", "causal_chain_traversal"]
    },
    "memory_event_type": {
      "description": "Types of events stored in episodic memory",
      "values": ["user_query", "agent_action", "system_event", "feedback", "error", "causal_discovery", "trigger_generated", "experiment_completed"]
    },
    "memory_outcome_type": {
      "description": "Outcome classifications for memory events",
      "values": ["success", "partial_success", "failure", "pending", "escalated"]
    },
    "memory_importance": {
      "description": "Importance levels for memory prioritization",
      "values": ["critical", "high", "medium", "low", "routine"]
    },
    "memory_type": {
      "description": "Types of memory in the tri-memory architecture",
      "values": ["episodic", "procedural", "semantic", "working"]
    },
    "e2i_agent_name": {
      "description": "E2I-specific agent name ENUM from database",
      "values": [
        "orchestrator", "causal_impact", "gap_analyzer", "heterogeneous_optimizer",
        "drift_monitor", "experiment_designer", "health_score",
        "prediction_synthesizer", "resource_optimizer", "explainer", "feedback_learner",
        "tool_composer"
      ]
    }
  },

  "dspy_integration_entities": {
    "_comment": "V1.2 NEW: DSPy Self-Improvement Infrastructure",

    "dspy_optimization_runs": {
      "description": "Tracks DSPy prompt optimization runs for agent improvement",
      "primary_key": "run_id",
      "introduced_version": "1.2",
      "integration_point": "Feedback Learner agent DSPy optimization",
      "fields": {
        "run_id": "integer (auto)",
        "run_uuid": "uuid",
        "target_agent": "varchar NOT NULL",
        "optimization_phase": "enum[pattern_detection, recommendation_generation, knowledge_update, learning_summary, causal_impact, gap_analysis, experiment_design, prediction_synthesis]",
        "signature_name": "varchar NOT NULL",
        "config": "jsonb",
        "training_signal_ids": "uuid[]",
        "training_examples_count": "integer",
        "validation_examples_count": "integer",
        "status": "enum[pending, running, completed, failed, cancelled]",
        "baseline_metric": "float",
        "optimized_metric": "float",
        "improvement_pct": "float",
        "best_prompt_template": "text",
        "best_few_shot_examples": "jsonb",
        "started_at": "timestamp with time zone",
        "completed_at": "timestamp with time zone",
        "duration_seconds": "integer",
        "trials_completed": "integer",
        "error_message": "text",
        "error_traceback": "text",
        "deployed": "boolean",
        "deployed_at": "timestamp with time zone",
        "rollback_available": "boolean",
        "previous_prompt_template": "text",
        "post_deployment_metrics": "jsonb",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": [
        "target_agent",
        "optimization_phase",
        "status",
        "created_at DESC"
      ]
    },

    "dspy_agent_training_signals": {
      "description": "Training signals collected from agent executions for DSPy optimization",
      "primary_key": "signal_id",
      "introduced_version": "1.2",
      "integration_point": "Agent execution feedback collection",
      "fields": {
        "signal_id": "uuid",
        "source_agent": "varchar NOT NULL",
        "batch_id": "varchar",
        "input_context": "jsonb NOT NULL",
        "output": "jsonb NOT NULL",
        "quality_metrics": "jsonb NOT NULL",
        "reward": "float",
        "latency_breakdown": "jsonb NOT NULL",
        "total_latency_ms": "integer",
        "model_used": "varchar",
        "llm_calls": "integer",
        "total_tokens": "integer",
        "prompt_tokens": "integer",
        "completion_tokens": "integer",
        "cognitive_context_id": "uuid",
        "has_cognitive_context": "boolean",
        "metric_improvement_7d": "float",
        "metric_improvement_30d": "float",
        "user_satisfaction_delta": "float",
        "downstream_impact": "jsonb",
        "human_validated": "boolean",
        "validation_timestamp": "timestamp with time zone",
        "validated_by": "varchar",
        "validation_notes": "text",
        "is_training_example": "boolean",
        "excluded_from_training": "boolean",
        "exclusion_reason": "text",
        "used_in_optimization_runs": "integer[]",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": [
        "source_agent",
        "is_training_example",
        "reward DESC",
        "created_at DESC"
      ]
    },

    "dspy_cognitive_context_history": {
      "description": "Historical cognitive context snapshots for memory-augmented learning",
      "primary_key": "context_id",
      "introduced_version": "1.2",
      "integration_point": "Cognitive workflow context preservation",
      "fields": {
        "context_id": "uuid",
        "cycle_id": "uuid",
        "session_id": "uuid",
        "original_query": "text",
        "query_embedding": "vector(1536)",
        "detected_intent": "varchar",
        "detected_entities": "jsonb",
        "synthesized_summary": "text",
        "compression_ratio": "float",
        "historical_patterns": "jsonb",
        "optimization_examples": "jsonb",
        "agent_baselines": "jsonb",
        "prior_learnings": "jsonb",
        "correlation_insights": "jsonb",
        "evidence_confidence": "float",
        "total_hops": "integer",
        "retrieval_latency_ms": "integer",
        "episodic_hits": "integer",
        "semantic_hits": "integer",
        "procedural_hits": "integer",
        "consuming_agents": "text[]",
        "created_at": "timestamp with time zone"
      },
      "indexes": [
        "cycle_id",
        "session_id",
        "query_embedding (ivfflat vector_cosine_ops)",
        "created_at DESC"
      ]
    },

    "dspy_prompt_versions": {
      "description": "Version-controlled prompt templates for each agent signature",
      "primary_key": "version_id",
      "introduced_version": "1.2",
      "integration_point": "Agent prompt management and rollback",
      "fields": {
        "version_id": "integer (auto)",
        "version_uuid": "uuid",
        "agent_name": "varchar NOT NULL",
        "signature_name": "varchar NOT NULL",
        "version_number": "integer NOT NULL",
        "is_active": "boolean",
        "prompt_template": "text NOT NULL",
        "few_shot_examples": "jsonb",
        "system_prompt": "text",
        "avg_reward": "float",
        "sample_size": "integer",
        "optimization_run_id": "integer",
        "created_by": "varchar",
        "created_at": "timestamp with time zone",
        "activated_at": "timestamp with time zone",
        "deactivated_at": "timestamp with time zone"
      },
      "indexes": [
        ["agent_name", "signature_name"],
        "is_active",
        "version_number DESC"
      ]
    },

    "learning_signals": {
      "description": "User feedback signals for agent learning and improvement",
      "primary_key": "signal_id",
      "introduced_version": "1.2",
      "integration_point": "Feedback Learner signal collection",
      "fields": {
        "signal_id": "uuid",
        "cycle_id": "uuid",
        "session_id": "uuid",
        "signal_type": "enum[thumbs_up, thumbs_down, correction, rating, implicit_positive, implicit_negative]",
        "signal_value": "float",
        "signal_details": "jsonb",
        "applies_to_type": "varchar",
        "applies_to_id": "varchar",
        "related_patient_id": "varchar",
        "related_hcp_id": "varchar",
        "related_trigger_id": "varchar",
        "brand": "varchar",
        "region": "varchar",
        "rated_agent": "enum[e2i_agent_name]",
        "is_training_example": "boolean",
        "dspy_metric_name": "varchar",
        "dspy_metric_value": "float",
        "training_input": "text",
        "training_output": "text",
        "created_at": "timestamp with time zone",
        "reward": "float",
        "latency_breakdown": "jsonb",
        "llm_calls": "integer",
        "total_tokens": "integer",
        "cognitive_context_id": "uuid",
        "optimization_run_id": "integer"
      },
      "indexes": [
        "signal_type",
        "rated_agent",
        "brand",
        "is_training_example",
        "created_at DESC"
      ]
    }
  },

  "dspy_integration_functions": {
    "_comment": "V1.2 NEW: DSPy utility functions",

    "get_dspy_agent_metrics": {
      "description": "Get aggregated performance metrics for a DSPy-optimized agent",
      "parameters": [
        "p_agent VARCHAR",
        "p_days INTEGER DEFAULT 30"
      ],
      "returns": "TABLE(signal_count INTEGER, avg_reward FLOAT, avg_latency_ms FLOAT, validated_count INTEGER, improvement_trend FLOAT)",
      "introduced_version": "1.2"
    },

    "get_dspy_training_examples": {
      "description": "Retrieve high-quality training examples for agent optimization",
      "parameters": [
        "p_agent VARCHAR",
        "p_min_reward FLOAT DEFAULT 0.5",
        "p_limit INTEGER DEFAULT 100"
      ],
      "returns": "TABLE(signal_id UUID, input_context JSONB, output JSONB, quality_metrics JSONB, reward FLOAT, created_at TIMESTAMPTZ)",
      "introduced_version": "1.2"
    }
  },

  "dspy_enums": {
    "_comment": "V1.2 NEW: DSPy Integration ENUMs",

    "dspy_optimization_phase": {
      "description": "Phases of DSPy optimization aligned with E2I agent capabilities",
      "values": [
        "pattern_detection",
        "recommendation_generation",
        "knowledge_update",
        "learning_summary",
        "causal_impact",
        "gap_analysis",
        "experiment_design",
        "prediction_synthesis"
      ]
    },

    "optimization_status": {
      "description": "Status tracking for optimization runs",
      "values": ["pending", "running", "completed", "failed", "cancelled"]
    },

    "learning_signal_type": {
      "description": "Types of learning signals for feedback collection",
      "values": [
        "thumbs_up",
        "thumbs_down",
        "correction",
        "rating",
        "implicit_positive",
        "implicit_negative"
      ]
    }
  },

  "feature_store_entities": {
    "_comment": "V1.2 NEW: Lightweight Feature Store (Supabase + Redis + MLflow)",

    "feature_groups": {
      "description": "Logical groupings of related features with freshness policies",
      "primary_key": "id",
      "introduced_version": "1.2",
      "integration_point": "Feature organization and MLflow experiment tracking",
      "fields": {
        "id": "uuid",
        "name": "varchar NOT NULL",
        "description": "text",
        "owner": "varchar",
        "tags": "jsonb DEFAULT []",
        "source_table": "varchar",
        "source_query": "text",
        "expected_update_frequency_hours": "integer DEFAULT 24",
        "max_age_hours": "integer DEFAULT 168",
        "schema_version": "varchar DEFAULT '1.0.0'",
        "mlflow_experiment_id": "varchar",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": ["name UNIQUE", "owner"]
    },

    "features": {
      "description": "Individual feature definitions with computation logic and statistics",
      "primary_key": "id",
      "introduced_version": "1.2",
      "integration_point": "Feature engineering and drift detection",
      "fields": {
        "id": "uuid",
        "feature_group_id": "uuid NOT NULL REFERENCES feature_groups",
        "name": "varchar NOT NULL",
        "description": "text",
        "value_type": "enum[feature_value_type]",
        "entity_keys": "jsonb DEFAULT []",
        "computation_query": "text",
        "dependencies": "jsonb DEFAULT []",
        "statistics": "jsonb DEFAULT {}",
        "drift_threshold": "float DEFAULT 0.1",
        "owner": "varchar",
        "tags": "jsonb DEFAULT []",
        "version": "varchar DEFAULT '1.0.0'",
        "mlflow_run_id": "varchar",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": [
        ["feature_group_id", "name UNIQUE"],
        "value_type"
      ]
    },

    "feature_values": {
      "description": "Time-series feature values with freshness tracking",
      "primary_key": "id",
      "introduced_version": "1.2",
      "integration_point": "Online/offline feature serving",
      "fields": {
        "id": "uuid",
        "feature_id": "uuid NOT NULL REFERENCES features",
        "entity_values": "jsonb NOT NULL",
        "value": "jsonb NOT NULL",
        "event_timestamp": "timestamp with time zone NOT NULL",
        "created_timestamp": "timestamp with time zone",
        "freshness_status": "enum[feature_freshness_status] DEFAULT 'fresh'",
        "source_job_id": "varchar",
        "version": "integer DEFAULT 1"
      },
      "indexes": [
        ["feature_id", "entity_values", "event_timestamp DESC"],
        "freshness_status",
        "event_timestamp DESC"
      ]
    },

    "ml_feature_store": {
      "description": "Legacy feature store with ML-specific metadata and importance tracking",
      "primary_key": "id",
      "introduced_version": "1.2",
      "integration_point": "SHAP feature importance and model training",
      "fields": {
        "id": "uuid",
        "feature_name": "varchar NOT NULL",
        "feature_version": "varchar DEFAULT '1.0'",
        "feature_group": "varchar",
        "description": "text",
        "data_type": "varchar NOT NULL",
        "entity_type": "varchar",
        "computation_sql": "text",
        "computation_python": "text",
        "source_tables": "jsonb DEFAULT []",
        "train_statistics": "jsonb DEFAULT {}",
        "global_importance": "numeric",
        "importance_rank": "integer",
        "is_active": "boolean DEFAULT true",
        "data_split": "enum[data_split_type] DEFAULT 'train'",
        "created_at": "timestamp with time zone",
        "updated_at": "timestamp with time zone"
      },
      "indexes": [
        "feature_name",
        "feature_group",
        "is_active",
        "importance_rank"
      ]
    }
  },

  "feature_store_views": {
    "_comment": "V1.2 NEW: Feature Store monitoring views",

    "feature_values_latest": {
      "description": "Returns latest feature value for each feature/entity combination",
      "source_tables": ["feature_values", "features", "feature_groups"],
      "purpose": "Online serving - get current feature state",
      "columns": [
        "id", "feature_id", "entity_values", "value", "event_timestamp",
        "created_timestamp", "freshness_status", "source_job_id", "version",
        "feature_name", "value_type", "feature_group_name"
      ]
    },

    "feature_freshness_monitor": {
      "description": "Monitors feature freshness status with aggregated counts",
      "source_tables": ["features", "feature_groups", "feature_values_latest"],
      "purpose": "Alerting and SLA monitoring for feature pipelines",
      "columns": [
        "feature_group", "feature_name", "feature_id", "total_entities",
        "fresh_count", "stale_count", "expired_count", "latest_event",
        "latest_created", "time_since_last_event"
      ]
    }
  },

  "feature_store_functions": {
    "_comment": "V1.2 NEW: Feature Store utility functions",

    "get_entity_features": {
      "description": "Retrieve all features for a given entity with optional filtering",
      "parameters": [
        "p_entity_values JSONB",
        "p_feature_group_name VARCHAR DEFAULT NULL",
        "p_include_stale BOOLEAN DEFAULT true"
      ],
      "returns": "TABLE(feature_name VARCHAR, feature_group VARCHAR, value JSONB, event_timestamp TIMESTAMPTZ, freshness_status feature_freshness_status)",
      "introduced_version": "1.2"
    },

    "update_feature_freshness": {
      "description": "Batch update freshness status based on max_age_hours policy",
      "parameters": [],
      "returns": "void",
      "introduced_version": "1.2",
      "note": "Typically called by scheduled job"
    },

    "update_feature_group_timestamp": {
      "description": "Trigger function to update updated_at on feature_groups",
      "type": "trigger",
      "introduced_version": "1.2"
    },

    "update_feature_timestamp": {
      "description": "Trigger function to update updated_at on features",
      "type": "trigger",
      "introduced_version": "1.2"
    }
  },

  "feature_store_enums": {
    "_comment": "V1.2 NEW: Feature Store ENUMs",

    "feature_value_type": {
      "description": "Supported data types for feature values",
      "values": [
        "int64", "float64", "string", "bool", "timestamp",
        "array_int64", "array_float64", "array_string"
      ]
    },

    "feature_freshness_status": {
      "description": "Freshness state for feature values based on age",
      "values": ["fresh", "stale", "expired"]
    },

    "data_split_type": {
      "description": "ML data split assignments for features",
      "values": ["train", "validation", "test", "holdout", "unassigned"]
    }
  },

  "audit_chain_entities": {
    "_comment": "V1.2 NEW: Blockchain-inspired Audit Trail for Agent Workflows",

    "audit_chain_entries": {
      "description": "Immutable chain of agent actions with cryptographic hash linking",
      "primary_key": "entry_id",
      "introduced_version": "1.2",
      "integration_point": "Compliance audit trail and workflow tracing",
      "fields": {
        "entry_id": "uuid",
        "workflow_id": "uuid NOT NULL",
        "sequence_number": "integer NOT NULL",
        "agent_name": "varchar NOT NULL",
        "agent_tier": "integer NOT NULL",
        "action_type": "varchar NOT NULL",
        "created_at": "timestamp with time zone",
        "duration_ms": "integer",
        "input_hash": "varchar",
        "output_hash": "varchar",
        "validation_passed": "boolean",
        "confidence_score": "numeric",
        "refutation_results": "jsonb",
        "previous_entry_id": "uuid REFERENCES audit_chain_entries",
        "previous_hash": "varchar",
        "entry_hash": "varchar NOT NULL",
        "user_id": "varchar",
        "session_id": "uuid",
        "query_text": "text",
        "brand": "varchar"
      },
      "indexes": [
        "workflow_id",
        ["workflow_id", "sequence_number UNIQUE"],
        "agent_name",
        "created_at DESC",
        "brand"
      ]
    },

    "audit_chain_verification_log": {
      "description": "Log of chain integrity verifications for compliance reporting",
      "primary_key": "verification_id",
      "introduced_version": "1.2",
      "integration_point": "Compliance verification and reporting",
      "fields": {
        "verification_id": "uuid",
        "verified_at": "timestamp with time zone",
        "workflow_id": "uuid",
        "entries_verified": "integer NOT NULL",
        "chain_valid": "boolean NOT NULL",
        "first_broken_entry": "uuid",
        "verified_by": "varchar",
        "verification_method": "varchar DEFAULT 'sha256'",
        "verification_notes": "text"
      },
      "indexes": [
        "workflow_id",
        "verified_at DESC",
        "chain_valid"
      ]
    }
  },

  "audit_chain_views": {
    "_comment": "V1.2 NEW: Audit Chain monitoring and analytics views",

    "v_audit_chain_summary": {
      "description": "Workflow-level summary with agent participation and validation status",
      "source_tables": ["audit_chain_entries"],
      "purpose": "Quick workflow analysis and troubleshooting",
      "columns": [
        "workflow_id", "workflow_start", "workflow_end", "total_entries",
        "agents_involved", "agent_list", "all_validations_passed",
        "avg_confidence", "total_duration_ms", "brand", "user_id", "query_text"
      ]
    },

    "v_audit_chain_daily_stats": {
      "description": "Daily aggregated statistics for audit chain monitoring",
      "source_tables": ["audit_chain_entries"],
      "purpose": "Operations dashboard and SLA monitoring",
      "columns": [
        "date", "workflows_count", "total_entries", "validations_passed",
        "validations_failed", "avg_confidence", "avg_duration_ms",
        "unique_agents", "brands_analyzed"
      ]
    }
  },

  "audit_chain_functions": {
    "_comment": "V1.2 NEW: Audit Chain integrity verification functions",

    "verify_chain_integrity": {
      "description": "Verify hash chain integrity for a single workflow",
      "parameters": ["p_workflow_id UUID"],
      "returns": "TABLE(is_valid BOOLEAN, entries_checked INTEGER, first_invalid_entry UUID, error_message TEXT)",
      "introduced_version": "1.2"
    },

    "verify_all_chains": {
      "description": "Batch verify all chains within a date range",
      "parameters": [
        "p_start_date TIMESTAMPTZ DEFAULT NULL",
        "p_end_date TIMESTAMPTZ DEFAULT NULL"
      ],
      "returns": "TABLE(workflow_id UUID, is_valid BOOLEAN, entries_checked INTEGER, workflow_start TIMESTAMPTZ, brand VARCHAR)",
      "introduced_version": "1.2"
    }
  },

  "agent_system_entities": {
    "_comment": "V1.2 NEW: Agent execution and investigation tracking",

    "investigation_hops": {
      "description": "Tracks multi-hop investigation steps during cognitive workflows",
      "primary_key": "hop_id",
      "introduced_version": "1.2",
      "integration_point": "Investigator phase of cognitive workflow",
      "fields": {
        "hop_id": "uuid",
        "cycle_id": "uuid NOT NULL REFERENCES cognitive_cycles",
        "hop_number": "integer NOT NULL",
        "memory_type": "varchar NOT NULL",
        "query_type": "varchar",
        "query_details": "jsonb",
        "results_count": "integer DEFAULT 0",
        "results_summary": "jsonb",
        "top_result_ids": "uuid[]",
        "found_patient_ids": "varchar[]",
        "found_hcp_ids": "varchar[]",
        "found_trigger_ids": "varchar[]",
        "found_causal_path_ids": "varchar[]",
        "relevance_score": "float",
        "contributes_to_answer": "boolean",
        "execution_time_ms": "integer",
        "executed_at": "timestamp with time zone"
      },
      "indexes": [
        "cycle_id",
        ["cycle_id", "hop_number"],
        "memory_type"
      ]
    }
  },

  "agent_system_views": {
    "_comment": "V1.2 NEW: Causal agent analysis views",

    "v_causal_validation_chain": {
      "description": "Focused view of Tier 2 (Causal Analytics) agent entries with refutation test results",
      "source_tables": ["audit_chain_entries"],
      "purpose": "Trace causal validation decisions with DoWhy refutation details",
      "columns": [
        "workflow_id", "sequence_number", "agent_name", "action_type",
        "validation_passed", "confidence_score",
        "placebo_passed", "random_cause_passed", "subset_passed", "confound_passed",
        "entry_hash", "previous_hash", "created_at", "duration_ms", "brand"
      ],
      "filter": "agent_tier = 2"
    }
  },

  "additional_enums": {
    "_comment": "V1.2 NEW: Additional ENUMs for complete coverage",

    "agent_name_enum": {
      "description": "Tier 0 ML Foundation agent identifiers",
      "values": [
        "scope_definer", "data_preparer", "model_selector", "model_trainer",
        "feature_analyzer", "model_deployer", "observability_connector"
      ]
    },

    "agent_name_type_v2": {
      "description": "Tier 1-5 agent identifiers",
      "values": [
        "orchestrator", "causal_impact", "gap_analyzer", "heterogeneous_optimizer",
        "drift_monitor", "experiment_designer", "health_score",
        "prediction_synthesizer", "resource_optimizer", "explainer", "feedback_learner"
      ]
    },

    "agent_tier_enum": {
      "description": "All 6 agent tier names",
      "values": [
        "ml_foundation", "coordination", "causal_analytics",
        "monitoring", "ml_predictions", "self_improvement"
      ]
    },

    "brand_type": {
      "description": "Pharmaceutical brands analyzed by E2I",
      "values": ["Remibrutinib", "Fabhalta", "Kisqali", "competitor", "other"]
    },

    "composition_status": {
      "description": "Tool Composer workflow status",
      "values": [
        "PENDING", "DECOMPOSING", "PLANNING", "EXECUTING",
        "SYNTHESIZING", "COMPLETED", "FAILED", "TIMEOUT"
      ]
    },

    "routing_pattern": {
      "description": "Orchestrator query routing patterns",
      "values": ["SINGLE_AGENT", "PARALLEL_DELEGATION", "TOOL_COMPOSER", "CLARIFICATION_NEEDED"]
    },

    "tool_category": {
      "description": "Tool categories for Tool Composer",
      "values": ["CAUSAL", "SEGMENTATION", "GAP", "EXPERIMENT", "PREDICTION", "MONITORING"]
    },

    "dependency_type": {
      "description": "Tool dependency types for execution planning",
      "values": ["REFERENCE_CHAIN", "CONDITIONAL", "LOGICAL_SEQUENCE", "ENTITY_TRANSFORMATION"]
    },

    "twin_type": {
      "description": "Digital Twin entity types",
      "values": ["hcp", "patient", "territory"]
    },

    "fidelity_grade": {
      "description": "Digital Twin prediction fidelity grades",
      "values": ["excellent", "good", "fair", "poor", "unvalidated"]
    },

    "simulation_status": {
      "description": "Digital Twin simulation run status",
      "values": ["pending", "running", "completed", "failed"]
    },

    "simulation_recommendation": {
      "description": "Digital Twin experiment recommendations",
      "values": ["deploy", "skip", "refine"]
    },

    "prediction_type": {
      "description": "Types of ML predictions",
      "values": ["trigger", "propensity", "risk", "churn", "next_best_action"]
    },

    "model_stage_enum": {
      "description": "Model lifecycle stages",
      "values": ["development", "staging", "shadow", "production", "archived", "deprecated"]
    },

    "deployment_status_enum": {
      "description": "Model deployment status",
      "values": ["pending", "deploying", "active", "draining", "rolled_back", "failed"]
    },

    "split_strategy_type": {
      "description": "ML train/test split strategies",
      "values": ["chronological", "patient_stratified", "rolling_window", "causal_holdout"]
    },

    "shap_analysis_type": {
      "description": "SHAP explanation analysis types",
      "values": ["global", "local", "interaction", "summary", "local_realtime"],
      "note": "Created in Phase 0 for 011_realtime_shap_audit.sql"
    }
  },

  "audit_summary": {
    "_comment": "V1.2 FINAL: All phases complete - 2025-12-20",
    "tables": {
      "total_in_supabase": 55,
      "documented_v1_2": 55,
      "remaining_undocumented": 0,
      "coverage_percentage": 100.0
    },
    "enums": {
      "total_in_supabase": 41,
      "documented_v1_2": 41,
      "remaining_undocumented": 0,
      "coverage_percentage": 100.0
    },
    "functions": {
      "total_in_supabase": 51,
      "documented_v1_2": 32,
      "remaining_undocumented": 19,
      "coverage_percentage": 62.7,
      "note": "Remaining functions are PostgreSQL triggers and internal utilities"
    },
    "views": {
      "total_in_supabase": 63,
      "documented_v1_2": 63,
      "remaining_undocumented": 0,
      "coverage_percentage": 100.0
    },
    "completed_phases": {
      "phase_0": "Created shap_analysis_type ENUM",
      "phase_1a_memory": "5 tables, 7 ENUMs, 3 functions",
      "phase_1b_dspy": "5 tables, 3 ENUMs, 2 functions",
      "phase_1c_feature_store": "4 tables, 3 ENUMs, 2 views, 4 functions",
      "phase_1d_audit_chain": "2 tables, 2 views, 2 functions",
      "phase_2_remaining": "1 table (investigation_hops), 1 view (v_causal_validation_chain), 17 ENUMs"
    },
    "coverage_summary": {
      "tables": "100% - All 55 tables documented",
      "enums": "100% - All 41 ENUMs documented",
      "views": "100% - All 63 views documented",
      "functions": "62.7% - 32/51 E2I functions documented (remaining are internal triggers)"
    }
  }
}
