# =============================================================================
# E2I Causal Analytics - Development Overrides
# =============================================================================
# This file extends docker-compose.yml with development-specific settings:
#   - Bind mounts for hot-reloading
#   - Debug logging
#   - Development commands
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up
#
# Or with the Makefile:
#   make dev
# =============================================================================

services:
  # ===========================================================================
  # API - Development Overrides
  # ===========================================================================
  api:
    build:
      target: development  # Use development stage of Dockerfile
    container_name: e2i_api_dev
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    ports:
      - "8000:8000"
      - "5678:5678"  # debugpy port for VS Code debugging
    volumes:
      # -----------------------------------------------------------------------
      # BIND MOUNTS - Hot-reloading for development
      # -----------------------------------------------------------------------
      - ../src:/app/src                    # Python source code
      - ../config:/app/config              # YAML configurations
      - ../tests:/app/tests                # Test files
      
      # Prevent bind mount from overwriting container's installed packages
      - /app/src/__pycache__
      - /app/.venv
      
      # -----------------------------------------------------------------------
      # SHARED VOLUMES - Still needed for data exchange
      # -----------------------------------------------------------------------
      - ml_artifacts:/app/data/ml_artifacts
      - causal_outputs:/app/data/causal_outputs
      - agent_outputs:/app/data/agent_outputs
      - experiment_designs:/app/data/experiment_designs
      - feature_cache:/app/data/feature_cache:ro
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      
      # Enable debugpy for VS Code remote debugging
      - DEBUGPY_ENABLE=true
      - DEBUGPY_PORT=5678
    command: >
      uvicorn src.api.main:app
      --reload
      --reload-dir /app/src
      --host 0.0.0.0
      --port 8000
      --log-level debug
    # Remove healthcheck timeout pressure in dev
    healthcheck:
      interval: 60s
      timeout: 30s
      start_period: 120s

  # ===========================================================================
  # Workers - Development Overrides
  # ===========================================================================

  worker_light:
    build:
      target: development
    # NOTE: no container_name â€” base compose has replicas: 2, which conflicts with container_name
    volumes:
      - ../src:/app/src
      - ../config:/app/config
      - ../tests:/app/tests
      - /app/src/__pycache__
      - /app/.venv
      - ml_artifacts:/app/data/ml_artifacts
      - causal_outputs:/app/data/causal_outputs
      - agent_outputs:/app/data/agent_outputs
      - experiment_designs:/app/data/experiment_designs
      - feature_cache:/app/data/feature_cache:ro
    tmpfs:
      - /app/tmp:size=512M,mode=1770
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - WORKER_TYPE=light
    command: >
      celery -A src.workers.celery_app worker
      --loglevel=DEBUG
      --concurrency=2
      --queues=default,quick,api
      --pool=solo
      --hostname=worker_light@%h
    healthcheck:
      test: ["CMD", "echo", "ok"]
      interval: 120s

  worker_medium:
    build:
      target: development
    container_name: e2i_worker_medium_dev
    volumes:
      - ../src:/app/src
      - ../config:/app/config
      - ../tests:/app/tests
      - /app/src/__pycache__
      - /app/.venv
      - ml_artifacts:/app/data/ml_artifacts
      - causal_outputs:/app/data/causal_outputs
      - agent_outputs:/app/data/agent_outputs
      - experiment_designs:/app/data/experiment_designs
      - feature_cache:/app/data/feature_cache:ro
    tmpfs:
      - /app/tmp:size=2G,mode=1770
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - WORKER_TYPE=medium
    command: >
      celery -A src.workers.celery_app worker
      --loglevel=DEBUG
      --concurrency=1
      --queues=analytics,reports,aggregations
      --pool=solo
      --hostname=worker_medium@%h
    healthcheck:
      test: ["CMD", "echo", "ok"]
      interval: 120s

  worker_heavy:
    build:
      target: development
    container_name: e2i_worker_heavy_dev
    volumes:
      - ../src:/app/src
      - ../config:/app/config
      - ../tests:/app/tests
      - /app/src/__pycache__
      - /app/.venv
      - ml_artifacts:/app/data/ml_artifacts
      - causal_outputs:/app/data/causal_outputs
      - agent_outputs:/app/data/agent_outputs
      - experiment_designs:/app/data/experiment_designs
      - feature_cache:/app/data/feature_cache:ro
    tmpfs:
      - /app/tmp:size=4G,mode=1770
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - WORKER_TYPE=heavy
      - OMP_NUM_THREADS=8
      - OPENBLAS_NUM_THREADS=8
    command: >
      celery -A src.workers.celery_app worker
      --loglevel=DEBUG
      --concurrency=1
      --queues=shap,causal,ml,twins
      --pool=solo
      --hostname=worker_heavy@%h
    healthcheck:
      test: ["CMD", "echo", "ok"]
      interval: 120s
    profiles:
      - heavy  # Only start with --profile heavy

  # ===========================================================================
  # Scheduler - Development Overrides
  # ===========================================================================
  scheduler:
    build:
      target: development
    container_name: e2i_scheduler_dev
    volumes:
      - ../src:/app/src
      - ../config:/app/config
      - /app/src/__pycache__
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG

  # ===========================================================================
  # Frontend - Development Overrides (Vite Dev Server)
  # ===========================================================================
  frontend:
    build:
      target: development
    container_name: e2i_frontend_dev
    # Override base ports (base has 3002:80, dev needs 3002:5173)
    # Compose merges port arrays, so we must use !override to replace
    ports: !override
      - "3002:5173"  # Vite dev server port
    volumes:
      # -----------------------------------------------------------------------
      # BIND MOUNTS - React source for hot-reloading
      # -----------------------------------------------------------------------
      - ../frontend/src:/app/src
      - ../frontend/public:/app/public
      - ../frontend/index.html:/app/index.html
      
      # Keep node_modules in container (OS-specific binaries)
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_API_URL=/api
      - VITE_WS_URL=wss://eznomics.site
    command: npm run dev -- --host 0.0.0.0 --port 5173
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
      interval: 30s
      start_period: 60s

  # ===========================================================================
  # MLOps Services - Development Overrides (Optional Debugging)
  # ===========================================================================
  
  mlflow:
    container_name: e2i_mlflow_dev
    environment:
      - MLFLOW_TRACKING_URI=sqlite:///mlflow/db/mlflow.db
    # Port 5000 already exposed by base compose (127.0.0.1:5000:5000)

  bentoml:
    container_name: e2i_bentoml_dev
    build:
      context: ..
      dockerfile: docker/bentoml/Dockerfile
      target: production
    volumes:
      - ../scripts/bentoml/e2i_serving_service.py:/home/bentoml/e2i_serving_service.py
      - ../src/mlops/bentoml_service.py:/home/bentoml/src/mlops/bentoml_service.py
      - ../src/mlops/bentoml_templates:/home/bentoml/src/mlops/bentoml_templates
    environment:
      - LOG_LEVEL=DEBUG
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 2G

  # ===========================================================================
  # Infrastructure - No changes needed (Redis, FalkorDB)
  # ===========================================================================
  
  redis:
    container_name: e2i_redis_dev
    # Preserve auth + memory limit from base, add verbose logging for dev
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD must be set}
      --loglevel verbose

  falkordb:
    container_name: e2i_falkordb_dev

# =============================================================================
# DEVELOPMENT-ONLY SERVICES
# =============================================================================

  # ---------------------------------------------------------------------------
  # Flower - Celery Monitoring Dashboard (Dev Only)
  # ---------------------------------------------------------------------------
  flower:
    image: mher/flower:latest
    container_name: e2i_flower_dev
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - FLOWER_PORT=5555
      - FLOWER_BASIC_AUTH=${FLOWER_USER:-admin}:${FLOWER_PASSWORD:-admin}
    networks:
      - e2i_network
    depends_on:
      redis:
        condition: service_healthy
    profiles:
      - dev-tools

  # ---------------------------------------------------------------------------
  # Redis Commander - Redis GUI (Dev Only)
  # ---------------------------------------------------------------------------
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: e2i_redis_commander_dev
    ports:
      - "8081:8081"
    environment:
      - REDIS_HOSTS=working:redis:6379:0:${REDIS_PASSWORD},celery-broker:redis:6379:1:${REDIS_PASSWORD},celery-results:redis:6379:2:${REDIS_PASSWORD},semantic:falkordb:6379:0:${FALKORDB_PASSWORD}
    networks:
      - e2i_network
    depends_on:
      - redis
      - falkordb
    profiles:
      - dev-tools

  # ---------------------------------------------------------------------------
  # Test Runner - Pytest in Container (Dev Only)
  # ---------------------------------------------------------------------------
  test:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: development
    container_name: e2i_test_runner
    volumes:
      - ../src:/app/src
      - ../tests:/app/tests
      - ../config:/app/config
      - /app/src/__pycache__
    environment:
      - ENVIRONMENT=test
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - FALKORDB_URL=redis://:${FALKORDB_PASSWORD}@falkordb:6379/0
      - PYTHONDONTWRITEBYTECODE=1
    command: pytest tests/ -v --cov=src --cov-report=html
    networks:
      - e2i_network
    depends_on:
      - redis
      - falkordb
    profiles:
      - testing
