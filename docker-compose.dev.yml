# E2I Causal Analytics - Development Environment Overrides
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up

version: '3.8'

services:
  # FastAPI - Development Configuration
  fastapi:
    env_file:
      - .env.dev  # Use development environment file
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
    ports:
      - "8000:8000"  # Expose for direct access
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src:ro
      - ./config:/app/config:ro
      - ./tests:/app/tests:ro
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      - RELOAD=true
      # Permissive CORS for local development
      - CORS_ORIGINS=http://localhost:3000,http://localhost:3001,http://127.0.0.1:3000
      # Docker-internal service URLs (override .env localhost values)
      - REDIS_URL=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - FALKORDB_HOST=falkordb
      - FALKORDB_PORT=6379
      - FALKORDB_URL=redis://falkordb:6379
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    # No resource limits in development

  # Frontend - Development Configuration
  frontend:
    env_file:
      - .env.dev  # Use development environment file
    command: npm start
    ports:
      - "3000:3000"  # Expose for direct access
    volumes:
      # Mount source for hot reload
      - ./frontend/src:/app/src:ro
      - ./frontend/public:/app/public:ro
      # Use node_modules from image (don't mount)
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - REACT_APP_API_URL=http://localhost:8000
      - CHOKIDAR_USEPOLLING=true  # Enable hot reload in Docker
      - WDS_SOCKET_PORT=0         # WebSocket for hot reload
    stdin_open: true  # Needed for React dev server
    tty: true

  # MLflow - Development Configuration
  mlflow:
    env_file:
      - .env.dev  # Use development environment file
    command: mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:////mlflow/mlflow.db --default-artifact-root /mlflow/mlflow-artifacts
    ports:
      - "5000:5000"  # Expose UI for direct access
    volumes:
      # Mount local artifact storage for persistence
      - ./data/mlflow-artifacts:/mlflow/mlflow-artifacts
      - mlflow-data:/mlflow  # Persist SQLite database
    environment:
      - MLFLOW_TRACKING_URI=http://localhost:5000

  # Redis - Development Configuration
  redis:
    ports:
      - "6379:6379"  # Expose for debugging tools (e.g., Redis Commander)
    command: redis-server --appendonly yes --requirepass devpassword

  # FalkorDB - Development Configuration
  falkordb:
    ports:
      - "6381:6379"  # Expose for host debugging tools

  # Agent Worker - Development Configuration
  agent-worker:
    env_file:
      - .env.dev  # Use development environment file
    container_name: e2i-agent-worker
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src:ro
      - ./config:/app/config:ro
    environment:
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      # Docker-internal service URLs (override .env localhost values)
      - REDIS_URL=redis://redis:6379
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - FALKORDB_HOST=falkordb
      - FALKORDB_PORT=6379
      - FALKORDB_URL=redis://falkordb:6379
      - MLFLOW_TRACKING_URI=http://mlflow:5000

  # Nginx - Disabled in Development (access services directly)
  nginx:
    profiles:
      - production  # Only run when 'production' profile is active
    # In dev, we access services directly via exposed ports

# Development-only services
  # Redis Commander - Web UI for Redis debugging
  redis-commander:
    env_file:
      - .env.dev  # Use development environment file
    image: rediscommander/redis-commander:latest
    container_name: e2i-redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379:0:devpassword
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - backend-network
    profiles:
      - debug  # Only run when explicitly requested

  # PostgreSQL Admin (if self-hosting DB in future)
  # pgadmin:
  #   image: dpage/pgadmin4:latest
  #   container_name: e2i-pgadmin
  #   environment:
  #     - PGADMIN_DEFAULT_EMAIL=admin@e2i.local
  #     - PGADMIN_DEFAULT_PASSWORD=admin
  #   ports:
  #     - "5050:80"
  #   networks:
  #     - backend-network
  #   profiles:
  #     - debug

networks:
  frontend-network:
    driver: bridge

  backend-network:
    driver: bridge

volumes:
  mlflow-data:
  redis-data:
  falkordb-data:
