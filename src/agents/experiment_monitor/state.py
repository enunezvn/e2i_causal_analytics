"""State definitions for Experiment Monitor Agent.

This module defines the TypedDict structures for the experiment_monitor agent's state management.

Tier: 3 (Monitoring)
Agent Type: Standard (Fast Path)
Performance Target: <5s per experiment check
"""

from typing import Literal, NotRequired, Optional, TypedDict
from uuid import UUID

# Type aliases
MonitorStatus = Literal["pending", "checking", "analyzing", "alerting", "completed", "failed"]
HealthStatus = Literal["healthy", "warning", "critical", "unknown"]
AlertSeverity = Literal["info", "warning", "critical"]
AlertType = Literal["srm", "enrollment", "stale_data", "fidelity", "interim_trigger"]


class ExperimentSummary(TypedDict):
    """Summary of an experiment's current state."""

    experiment_id: str
    name: str
    status: str
    health_status: HealthStatus
    days_running: int
    total_enrolled: int
    enrollment_rate: float
    current_information_fraction: float


class SRMIssue(TypedDict):
    """Sample Ratio Mismatch detection result."""

    experiment_id: str
    detected: bool
    p_value: float
    chi_squared: float
    expected_ratio: dict
    actual_counts: dict
    severity: AlertSeverity


class EnrollmentIssue(TypedDict):
    """Enrollment rate issue."""

    experiment_id: str
    current_rate: float
    expected_rate: float
    days_below_threshold: int
    severity: AlertSeverity


class StaleDataIssue(TypedDict):
    """Stale data freshness issue."""

    experiment_id: str
    last_data_timestamp: str
    hours_since_update: float
    threshold_hours: float
    severity: AlertSeverity


class FidelityIssue(TypedDict):
    """Digital Twin fidelity issue."""

    experiment_id: str
    twin_simulation_id: str
    predicted_effect: float
    actual_effect: float
    prediction_error: float
    calibration_needed: bool
    severity: AlertSeverity


class InterimTrigger(TypedDict):
    """Interim analysis trigger notification."""

    experiment_id: str
    analysis_number: int
    information_fraction: float
    milestone_reached: str
    triggered: bool


class MonitorAlert(TypedDict):
    """Alert generated by the monitor agent."""

    alert_id: str
    alert_type: AlertType
    severity: AlertSeverity
    experiment_id: str
    experiment_name: str
    message: str
    details: dict
    recommended_action: str
    timestamp: str


class ErrorDetails(TypedDict):
    """Error information."""

    node: str
    error: str
    timestamp: str


class ExperimentMonitorState(TypedDict):
    """Complete state for Experiment Monitor Agent.

    Total Fields: 22

    Field Groups:
    - Input (3): query, experiment_ids, check_all_active
    - Configuration (5): srm_threshold, enrollment_threshold, fidelity_threshold,
                        stale_data_threshold_hours, check_interim
    - Monitoring outputs (5): experiments, srm_issues, enrollment_issues,
                             stale_data_issues, fidelity_issues
    - Trigger outputs (1): interim_triggers
    - Alerts (1): alerts
    - Summary (2): monitor_summary, recommended_actions
    - Execution metadata (2): check_latency_ms, experiments_checked
    - Error handling (3): errors, warnings, status
    """

    # ===== Input Fields (3) =====
    query: str
    experiment_ids: NotRequired[list[str]]
    check_all_active: bool

    # ===== Configuration (5) =====
    srm_threshold: float  # P-value threshold for SRM detection (default: 0.001)
    enrollment_threshold: float  # Min daily enrollment rate
    fidelity_threshold: float  # Max acceptable prediction error
    stale_data_threshold_hours: float  # Hours after which data is considered stale (default: 24)
    check_interim: bool  # Whether to check for interim analysis triggers

    # ===== Monitoring Outputs (5) =====
    experiments: NotRequired[list[ExperimentSummary]]
    srm_issues: NotRequired[list[SRMIssue]]
    enrollment_issues: NotRequired[list[EnrollmentIssue]]
    stale_data_issues: NotRequired[list[StaleDataIssue]]
    fidelity_issues: NotRequired[list[FidelityIssue]]

    # ===== Trigger Outputs (1) =====
    interim_triggers: NotRequired[list[InterimTrigger]]

    # ===== Alerts (1) =====
    alerts: NotRequired[list[MonitorAlert]]

    # ===== Summary (2) =====
    monitor_summary: NotRequired[str]
    recommended_actions: NotRequired[list[str]]

    # ===== Execution Metadata (2) =====
    check_latency_ms: NotRequired[int]
    experiments_checked: NotRequired[int]

    # ===== Error Handling (3) =====
    errors: list[ErrorDetails]
    warnings: list[str]
    status: MonitorStatus

    # ===== Audit Chain (1) =====
    audit_workflow_id: NotRequired[Optional[UUID]]
