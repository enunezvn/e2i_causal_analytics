# Orchestrator Dispatch Rules
# Version: 1.0
# Last Updated: 2025-12-18
# Purpose: Define routing rules and dispatch logic for the Orchestrator agent

# ==============================================================================
# ROUTING CONFIGURATION
# ==============================================================================

routing_config:
  version: "1.0"
  description: "Intent-based routing rules for agent dispatch"

  # Global settings
  global:
    default_execution_mode: sequential
    enable_parallel_execution: true
    max_parallel_agents: 5
    default_timeout_seconds: 120
    enable_fallback: true
    enable_circuit_breaker: true

# ==============================================================================
# INTENT-BASED ROUTING RULES
# ==============================================================================

intent_routing:

  # ============
  # CAUSAL INTENT
  # ============
  causal:
    description: "Causal questions (What caused X? Why did Y happen?)"
    examples:
      - "What caused the drop in NRx for Kisqali?"
      - "Why did sales increase in Q3?"
      - "What's driving the churn rate?"

    # Primary agents (always dispatched)
    primary_agents:
      - agent: causal_impact
        priority: 1.0
        required: true
        execution_mode: sequential

    # Optional agents (dispatched based on criteria)
    optional_agents:
      - agent: gap_analyzer
        priority: 0.8
        required: false
        execution_mode: sequential
        dispatch_if:
          - condition: "causal_impact.confidence >= 0.7"
          - condition: "query contains ['opportunity', 'gap', 'improve']"

      - agent: heterogeneous_optimizer
        priority: 0.7
        required: false
        execution_mode: parallel_with: [gap_analyzer]
        dispatch_if:
          - condition: "entities.segments exists"
          - condition: "causal_impact.cate_detected == true"

      - agent: explainer
        priority: 0.9
        required: true
        execution_mode: sequential
        dispatch_if:
          - condition: "user_expertise in ['executive', 'analyst']"

    # Execution plan
    execution_plan:
      stages:
        - stage: 1
          agents: [causal_impact]
          parallel: false

        - stage: 2
          agents: [gap_analyzer, heterogeneous_optimizer]
          parallel: true
          optional: true

        - stage: 3
          agents: [explainer]
          parallel: false

    # Constraints
    constraints:
      max_total_time_seconds: 180
      min_confidence_threshold: 0.65

  # ============
  # WHAT-IF INTENT
  # ============
  what_if:
    description: "Hypothetical scenario questions (What if we...?)"
    examples:
      - "What if we increase targeting by 20%?"
      - "What would happen if we reallocate budget?"
      - "How would sales change if we add 5 reps?"

    primary_agents:
      - agent: experiment_designer
        priority: 1.0
        required: true
        execution_mode: sequential

    optional_agents:
      - agent: causal_impact
        priority: 0.8
        required: false
        execution_mode: sequential
        dispatch_if:
          - condition: "historical_data_available == true"

      - agent: prediction_synthesizer
        priority: 0.7
        required: false
        execution_mode: sequential
        dispatch_if:
          - condition: "models_available for prediction_target"

      - agent: explainer
        priority: 0.9
        required: true
        execution_mode: sequential

    execution_plan:
      stages:
        - stage: 1
          agents: [experiment_designer]
          parallel: false

        - stage: 2
          agents: [causal_impact, prediction_synthesizer]
          parallel: true
          optional: true

        - stage: 3
          agents: [explainer]
          parallel: false

    constraints:
      max_total_time_seconds: 90

  # ============
  # TREND INTENT
  # ============
  trend:
    description: "Trend analysis questions (How is X trending?)"
    examples:
      - "How is NRx trending?"
      - "Show me conversion rate trends"
      - "Is model accuracy declining?"

    primary_agents:
      - agent: drift_monitor
        priority: 1.0
        required: true
        execution_mode: sequential

    optional_agents:
      - agent: health_score
        priority: 0.7
        required: false
        execution_mode: parallel_with: [drift_monitor]
        dispatch_if:
          - condition: "query mentions ['system', 'health', 'performance']"

      - agent: explainer
        priority: 0.8
        required: false
        execution_mode: sequential
        dispatch_if:
          - condition: "drift_monitor.drift_detected == true"

    execution_plan:
      stages:
        - stage: 1
          agents: [drift_monitor, health_score]
          parallel: true

        - stage: 2
          agents: [explainer]
          parallel: false
          optional: true

    constraints:
      max_total_time_seconds: 20

  # ============
  # EXPLORATORY INTENT
  # ============
  exploratory:
    description: "Open-ended exploration (Show me..., Tell me about...)"
    examples:
      - "Show me opportunities for Kisqali"
      - "Tell me about Midwest performance"
      - "What's happening with high-volume HCPs?"

    primary_agents:
      - agent: gap_analyzer
        priority: 1.0
        required: true
        execution_mode: sequential

    optional_agents:
      - agent: causal_impact
        priority: 0.6
        required: false
        execution_mode: sequential
        dispatch_if:
          - condition: "causal_relationships_exist in entities"

      - agent: drift_monitor
        priority: 0.5
        required: false
        execution_mode: parallel_with: [gap_analyzer]
        dispatch_if:
          - condition: "time_period is recent"

      - agent: explainer
        priority: 0.9
        required: true
        execution_mode: sequential

    execution_plan:
      stages:
        - stage: 1
          agents: [gap_analyzer, drift_monitor]
          parallel: true

        - stage: 2
          agents: [causal_impact]
          parallel: false
          optional: true

        - stage: 3
          agents: [explainer]
          parallel: false

    constraints:
      max_total_time_seconds: 60

  # ============
  # COMPARATIVE INTENT
  # ============
  comparative:
    description: "Comparison questions (Compare X vs Y)"
    examples:
      - "Compare Kisqali vs Fabhalta performance"
      - "How does Midwest compare to Southeast?"
      - "Academic vs community practice differences?"

    primary_agents:
      - agent: gap_analyzer
        priority: 1.0
        required: true
        execution_mode: sequential

      - agent: heterogeneous_optimizer
        priority: 0.9
        required: true
        execution_mode: parallel_with: [gap_analyzer]

    optional_agents:
      - agent: explainer
        priority: 0.9
        required: true
        execution_mode: sequential

    execution_plan:
      stages:
        - stage: 1
          agents: [gap_analyzer, heterogeneous_optimizer]
          parallel: true

        - stage: 2
          agents: [explainer]
          parallel: false

    constraints:
      max_total_time_seconds: 45

  # ============
  # ML_TRAINING INTENT
  # ============
  ml_training:
    description: "ML model training requests"
    examples:
      - "Train a conversion prediction model"
      - "Build a churn model"
      - "Create a targeting model"

    primary_agents:
      # Tier 0 pipeline (MUST execute sequentially)
      - agent: scope_definer
        priority: 1.0
        required: true
        execution_mode: sequential

      - agent: data_preparer
        priority: 1.0
        required: true
        execution_mode: sequential
        depends_on: [scope_definer]
        blocking_gate: qc_gate

      - agent: model_selector
        priority: 1.0
        required: true
        execution_mode: sequential
        depends_on: [data_preparer]

      - agent: model_trainer
        priority: 1.0
        required: true
        execution_mode: sequential
        depends_on: [model_selector]

      - agent: feature_analyzer
        priority: 0.9
        required: true
        execution_mode: sequential
        depends_on: [model_trainer]

    optional_agents:
      - agent: model_deployer
        priority: 0.8
        required: false
        execution_mode: sequential
        depends_on: [feature_analyzer]
        dispatch_if:
          - condition: "model_trainer.validation_passed == true"
          - condition: "user requests deployment"

    execution_plan:
      stages:
        - stage: 1
          agents: [scope_definer]
          parallel: false

        - stage: 2
          agents: [data_preparer]
          parallel: false
          gate: qc_gate
          gate_condition: "qc_status == 'passed'"

        - stage: 3
          agents: [model_selector]
          parallel: false

        - stage: 4
          agents: [model_trainer]
          parallel: false
          long_running: true

        - stage: 5
          agents: [feature_analyzer]
          parallel: false

        - stage: 6
          agents: [model_deployer]
          parallel: false
          optional: true

    constraints:
      max_total_time_seconds: null  # No limit for training
      allow_long_running: true

  # ============
  # MODEL_DEPLOYMENT INTENT
  # ============
  model_deployment:
    description: "Model deployment requests"
    examples:
      - "Deploy conversion model to production"
      - "Promote model to staging"

    primary_agents:
      - agent: model_deployer
        priority: 1.0
        required: true
        execution_mode: sequential

    optional_agents:
      - agent: health_score
        priority: 0.7
        required: false
        execution_mode: sequential
        dispatch_if:
          - condition: "model_deployer.deployed == true"

    execution_plan:
      stages:
        - stage: 1
          agents: [model_deployer]
          parallel: false

        - stage: 2
          agents: [health_score]
          parallel: false
          optional: true

    constraints:
      max_total_time_seconds: 60

  # ============
  # MONITORING INTENT
  # ============
  monitoring:
    description: "System monitoring questions"
    examples:
      - "How is the system performing?"
      - "Check model health"
      - "Show me system metrics"

    primary_agents:
      - agent: health_score
        priority: 1.0
        required: true
        execution_mode: sequential

      - agent: drift_monitor
        priority: 0.9
        required: true
        execution_mode: parallel_with: [health_score]

    optional_agents:
      - agent: explainer
        priority: 0.7
        required: false
        execution_mode: sequential
        dispatch_if:
          - condition: "health_score.status != 'healthy'"
          - condition: "drift_monitor.drift_detected == true"

    execution_plan:
      stages:
        - stage: 1
          agents: [health_score, drift_monitor]
          parallel: true

        - stage: 2
          agents: [explainer]
          parallel: false
          optional: true

    constraints:
      max_total_time_seconds: 15

# ==============================================================================
# KPI-BASED ROUTING ENHANCEMENTS
# ==============================================================================

kpi_routing:
  description: "Additional routing based on detected KPIs"

  # Prescription metrics → Causal + Gap analysis
  prescription_metrics:
    kpis: [NRx, TRx, NBRx, market_share]
    additional_agents:
      - causal_impact
      - gap_analyzer

  # Model performance → Drift + Health
  model_performance:
    kpis: [model_accuracy, model_f1, model_auc, prediction_error]
    additional_agents:
      - drift_monitor
      - health_score

  # Data quality → Health
  data_quality:
    kpis: [match_rate, data_freshness, completeness_rate]
    additional_agents:
      - health_score

  # Engagement → Gap analysis
  engagement:
    kpis: [MAU, DAU, engagement_rate, session_duration]
    additional_agents:
      - gap_analyzer

  # Operational → Resource optimization
  operational:
    kpis: [time_to_release, inference_latency, cost_per_query]
    additional_agents:
      - resource_optimizer
      - health_score

# ==============================================================================
# PARALLEL EXECUTION RULES
# ==============================================================================

parallel_execution:
  description: "Rules for parallel agent execution"

  # Agents that CAN execute in parallel
  compatible_pairs:
    - agents: [gap_analyzer, heterogeneous_optimizer]
      reason: "Both Tier 2, independent analysis"

    - agents: [drift_monitor, health_score]
      reason: "Both Tier 3, independent monitoring"

    - agents: [prediction_synthesizer, resource_optimizer]
      reason: "Both Tier 4, independent predictions"

    - agents: [gap_analyzer, drift_monitor]
      reason: "Cross-tier, no shared state"

  # Agents that CANNOT execute in parallel (exclusive)
  exclusive_pairs:
    - agents: [scope_definer, data_preparer]
      reason: "Data preparer requires scope definition"

    - agents: [data_preparer, model_trainer]
      reason: "QC gate dependency"

    - agents: [model_trainer, feature_analyzer]
      reason: "SHAP requires trained model"

    - agents: [feature_analyzer, model_deployer]
      reason: "Deployment requires feature analysis"

    - agents: [causal_impact, gap_analyzer]
      reason: "Gap analyzer uses causal results"
      note: "Can be parallel if gap_analyzer doesn't depend on causal"

  # Maximum concurrent executions by tier
  tier_concurrency_limits:
    tier_0: 1  # ML Foundation: sequential pipeline
    tier_1: 1  # Orchestrator: single instance
    tier_2: 3  # Causal: up to 3 parallel
    tier_3: 3  # Monitoring: up to 3 parallel
    tier_4: 2  # Predictions: up to 2 parallel
    tier_5: 2  # Self-improvement: up to 2 parallel

# ==============================================================================
# PRIORITY HANDLING
# ==============================================================================

priority_config:
  description: "Priority-based dispatch configuration"

  # Priority levels
  levels:
    critical:
      weight: 1.0
      timeout_multiplier: 0.5  # Tighter timeout
      agents_allowed: all
      max_agents: 10

    high:
      weight: 0.8
      timeout_multiplier: 0.75
      agents_allowed: all
      max_agents: 7

    medium:
      weight: 0.5
      timeout_multiplier: 1.0
      agents_allowed: all
      max_agents: 5

    low:
      weight: 0.3
      timeout_multiplier: 1.5  # Relaxed timeout
      agents_allowed: [causal_impact, gap_analyzer, drift_monitor, health_score, explainer]
      max_agents: 3

  # Priority-based agent selection
  agent_priority_scores:
    # Tier 1
    orchestrator: 1.0

    # Tier 2 (Causal)
    causal_impact: 0.95
    gap_analyzer: 0.80
    heterogeneous_optimizer: 0.75

    # Tier 3 (Monitoring)
    experiment_designer: 0.70
    drift_monitor: 0.85
    health_score: 0.90

    # Tier 4 (Predictions)
    prediction_synthesizer: 0.75
    resource_optimizer: 0.70

    # Tier 5 (Self-improvement)
    explainer: 0.85
    feedback_learner: 0.50  # Async, low priority

    # Tier 0 (ML Foundation)
    scope_definer: 0.95
    data_preparer: 0.95
    model_selector: 0.90
    model_trainer: 0.90
    feature_analyzer: 0.85
    model_deployer: 0.80
    observability_connector: 1.0  # Cross-cutting

# ==============================================================================
# TIMEOUT CONFIGURATION
# ==============================================================================

timeout_config:
  description: "Timeout settings per agent and tier"

  # Agent-specific timeouts (seconds)
  agent_timeouts:
    # Tier 0
    scope_definer: 5
    data_preparer: 60
    model_selector: 120
    model_trainer: null  # No limit
    feature_analyzer: 120
    model_deployer: 30
    observability_connector: 1  # 1s for async background

    # Tier 1
    orchestrator: 2

    # Tier 2
    causal_impact: 120
    gap_analyzer: 20
    heterogeneous_optimizer: 150

    # Tier 3
    experiment_designer: 60
    drift_monitor: 10
    health_score: 5

    # Tier 4
    prediction_synthesizer: 15
    resource_optimizer: 20

    # Tier 5
    explainer: 45
    feedback_learner: null  # Async

  # Timeout multipliers by query priority
  priority_multipliers:
    critical: 0.5
    high: 0.75
    medium: 1.0
    low: 1.5

  # Global timeout
  global_max_timeout: 300  # 5 minutes

# ==============================================================================
# FALLBACK CHAINS
# ==============================================================================

fallback_chains:
  description: "Fallback strategies when agents fail"

  # LLM-based agents
  llm_agents:
    primary_fallback:
      - model: claude-opus-4-20250514
        timeout: 120
      - model: claude-sonnet-4-20250514
        timeout: 60
      - model: claude-haiku-4-20250414
        timeout: 30
      - fallback: cached_response
        max_age_hours: 24

  # Computation agents
  causal_agents:
    primary_fallback:
      - method: CausalForestDML
        timeout: 60
      - method: LinearDML
        timeout: 30
      - method: OLS
        timeout: 10
      - fallback: correlation_analysis

  # Fast agents (must return quickly)
  fast_agents:
    agents: [orchestrator, health_score, drift_monitor]
    fallback_strategy: cached_or_degraded
    max_fallback_age_minutes: 5

  # Long-running agents (can take time)
  long_running_agents:
    agents: [model_trainer, feature_analyzer]
    fallback_strategy: none  # No fallback
    allow_partial_results: true

# ==============================================================================
# CIRCUIT BREAKER CONFIGURATION
# ==============================================================================

circuit_breaker:
  description: "Circuit breaker pattern for agent failures"

  enabled: true

  # Global settings
  failure_threshold: 5  # Open circuit after 5 failures
  success_threshold: 2  # Close after 2 successes in half-open
  timeout_seconds: 60   # Half-open after 60s

  # Per-agent circuit breakers
  agents:
    causal_impact:
      failure_threshold: 3
      timeout_seconds: 120

    model_trainer:
      failure_threshold: 2
      timeout_seconds: 300

    health_score:
      failure_threshold: 5
      timeout_seconds: 30

    drift_monitor:
      failure_threshold: 5
      timeout_seconds: 30

  # Actions when circuit is open
  open_circuit_actions:
    - action: use_cached_response
      max_age_hours: 24

    - action: route_to_fallback
      fallback_agents: ["explainer"]

    - action: return_degraded_response
      message: "This feature is temporarily unavailable. Using cached data."

# ==============================================================================
# DISPATCH VALIDATION RULES
# ==============================================================================

validation_rules:
  description: "Rules to validate dispatch requests"

  # Pre-dispatch validation
  pre_dispatch:
    - rule: target_agent_exists
      severity: critical
      error: "Agent does not exist"

    - rule: dependencies_met
      severity: critical
      error: "Required dependencies not met"

    - rule: timeout_valid
      severity: high
      error: "Timeout exceeds maximum allowed"

    - rule: circular_dependency_check
      severity: critical
      error: "Circular dependency detected"

  # Post-dispatch validation
  post_dispatch:
    - rule: response_schema_valid
      severity: critical
      error: "Response does not match schema"

    - rule: execution_time_within_limit
      severity: high
      error: "Execution time exceeded limit"

    - rule: confidence_above_threshold
      severity: medium
      error: "Confidence below minimum threshold"

# ==============================================================================
# DISPATCH TEMPLATES
# ==============================================================================

dispatch_templates:
  description: "Common dispatch patterns"

  # Simple causal analysis
  simple_causal:
    agents: [causal_impact, explainer]
    execution_mode: sequential
    max_time_seconds: 180

  # Comprehensive causal analysis
  comprehensive_causal:
    agents: [causal_impact, gap_analyzer, heterogeneous_optimizer, explainer]
    execution_mode: mixed
    stages:
      - stage: 1
        agents: [causal_impact]
        parallel: false
      - stage: 2
        agents: [gap_analyzer, heterogeneous_optimizer]
        parallel: true
      - stage: 3
        agents: [explainer]
        parallel: false
    max_time_seconds: 240

  # System health check
  health_check:
    agents: [health_score, drift_monitor]
    execution_mode: parallel
    max_time_seconds: 15

  # ML training pipeline
  ml_pipeline:
    agents: [scope_definer, data_preparer, model_selector, model_trainer, feature_analyzer]
    execution_mode: sequential
    max_time_seconds: null  # No limit
    gates:
      - after: data_preparer
        condition: qc_passed == true

# ==============================================================================
# OBSERVABILITY INTEGRATION
# ==============================================================================

observability:
  description: "Observability integration for dispatch tracking"

  # Opik tracing
  opik:
    enabled: true
    trace_all_dispatches: true
    include_input_output: true
    include_errors: true

  # MLflow tracking
  mlflow:
    enabled: true
    log_agent_selections: true
    log_execution_times: true
    log_routing_decisions: true

  # Metrics to track
  metrics:
    - dispatch_count_by_intent
    - dispatch_count_by_agent
    - average_execution_time_by_agent
    - failure_rate_by_agent
    - timeout_rate_by_agent
    - parallel_execution_rate
    - circuit_breaker_open_count

# ==============================================================================
# END OF ORCHESTRATOR DISPATCH RULES
# ==============================================================================
