# =============================================================================
# COHORT CONSTRUCTOR DOMAIN VOCABULARY v1.0.0
# =============================================================================
#
# Purpose: Ontology for cohort definition, patient journey analysis, and
#          temporal relationship specification in pharmaceutical analytics
#
# Structure:
#   - Section 1: Core Clinical Entities
#   - Section 2: Cohort Definition Primitives
#   - Section 3: Temporal Relationships
#   - Section 4: Data Validation Rules
#   - Section 5: Query Intent Classification
#   - Section 6: Aliases & Fuzzy Matching
#   - Section 7: Example Queries
#
# Usage:
#   - SQL query generation uses these vocabularies
#   - NLP entity extraction for cohort specification
#   - Validation logic for criterion compatibility
#   - Frontend cohort builder dropdowns
#
# NO medical NER required - uses fixed vocabularies only.
#
# Changelog:
#   v1.0.0 - Initial cohort constructor vocabularies
# =============================================================================


# =============================================================================
# SECTION 1: CORE CLINICAL ENTITIES
# =============================================================================

brands:
  description: "Pharmaceutical brands for cohort filtering"
  values:
    - Remibrutinib
    - Fabhalta
    - Kisqali
  aliases:
    Remibrutinib: [remi, remibrutinib, rimibrutinib]
    Fabhalta: [fab, fabhalta]
    Kisqali: [kisq, kisqali, ribociclib]

diagnosis_codes:
  description: "ICD-10 diagnosis codes"
  pattern: "^[A-Z][0-9]{2}(\\.[0-9]{1,2})?$"
  examples:
    - L50.1  # Idiopathic urticaria (CSU)
    - D59.5  # Paroxysmal nocturnal hemoglobinuria (PNH)
    - C50.9  # Breast cancer

procedure_codes:
  description: "CPT/HCPCS procedure codes"
  pattern: "^[0-9]{5}$|^[A-Z][0-9]{4}$"
  examples:
    - "99213"  # Office visit
    - J0717    # Injection code

drug_codes:
  description: "NDC drug codes"
  pattern: "^[0-9]{5}-[0-9]{4}-[0-9]{2}$"
  examples:
    - "00078-0357-15"

lab_codes:
  description: "LOINC lab test codes"
  pattern: "^[0-9]{4,5}-[0-9]$"
  examples:
    - "718-7"   # Hemoglobin
    - "2160-0"  # Creatinine

patient_journey_stages:
  description: "Patient journey milestones"
  values:
    - diagnosis
    - treatment_naive
    - first_line
    - second_line
    - maintenance
    - discontinuation
    - switch
  
hcp_specialties:
  description: "Healthcare provider specialties"
  values:
    - oncologist
    - rheumatologist
    - dermatologist
    - nephrologist
    - hematologist
    - primary_care
    - other

regions:
  description: "US geographic regions"
  values:
    - northeast
    - south
    - midwest
    - west


# =============================================================================
# SECTION 2: COHORT DEFINITION PRIMITIVES
# =============================================================================

cohort_types:
  description: "Cohort construction methodologies"
  values:
    - inclusion_exclusion  # Traditional I/E criteria
    - propensity_matched   # PSM cohorts
    - event_based          # Define by event sequences
    - temporal_window      # Time-bound cohorts
    - control_treatment    # Treatment vs control

criterion_types:
  description: "Types of cohort criteria"
  values:
    - diagnosis_criterion
    - prescription_criterion
    - procedure_criterion
    - lab_criterion
    - demographic_criterion
    - temporal_criterion
    - exclusion_criterion

criterion_categories:
  description: "Logical grouping of criteria"
  values:
    - inclusion
    - exclusion
    - stratification
    - matching

temporal_operators:
  description: "Temporal relationship operators"
  values:
    - before
    - after
    - during
    - within_days
    - at_least_days_after
    - at_most_days_before
    - concurrent
    - never

comparison_operators:
  description: "Value comparison operators"
  values:
    - equals
    - not_equals
    - greater_than
    - less_than
    - greater_or_equal
    - less_or_equal
    - between
    - in_list
    - not_in_list
    - is_null
    - is_not_null

join_types:
  description: "SQL join strategies for cohort construction"
  values:
    - inner
    - left
    - right
    - full_outer
    - cross

aggregation_functions:
  description: "Aggregation functions for criterion evaluation"
  values:
    - count
    - sum
    - avg
    - min
    - max
    - first
    - last
    - any
    - all


# =============================================================================
# SECTION 3: TEMPORAL RELATIONSHIPS
# =============================================================================

temporal_relationship_types:
  description: "Named temporal relationship patterns"
  values:
    - index_event_based         # Define cohort entry by specific event
    - rolling_window            # Moving time window
    - fixed_lookback            # Fixed historical period
    - fixed_followup            # Fixed future period
    - treatment_episode         # From start to discontinuation
    - diagnosis_to_treatment    # Time from dx to tx

temporal_units:
  description: "Time granularity for temporal criteria"
  values:
    - days
    - weeks
    - months
    - years

temporal_anchors:
  description: "Reference points for temporal relationships"
  values:
    - cohort_entry_date        # When patient enters cohort
    - index_date               # Defined reference event
    - diagnosis_date
    - first_prescription_date
    - last_prescription_date
    - study_start_date
    - study_end_date

temporal_windows:
  description: "Pre-defined temporal windows"
  values:
    - baseline_period          # Pre-index period
    - treatment_period         # During treatment
    - washout_period           # Drug washout
    - followup_period          # Post-treatment


# =============================================================================
# SECTION 4: DATA VALIDATION RULES
# =============================================================================

validation_rules:
  description: "Cohort definition validation rules"
  rules:
    - name: "no_empty_cohort"
      check: "cohort_size > 0"
      severity: error
      
    - name: "minimum_cohort_size"
      check: "cohort_size >= 30"
      severity: warning
      
    - name: "temporal_consistency"
      check: "all temporal relationships are logically consistent"
      severity: error
      
    - name: "no_circular_dependencies"
      check: "criterion dependency graph is acyclic"
      severity: error
      
    - name: "valid_date_ranges"
      check: "start_date <= end_date"
      severity: error
      
    - name: "no_impossible_exclusions"
      check: "exclusion criteria don't eliminate all inclusion matches"
      severity: warning

data_quality_checks:
  description: "Data quality validations"
  checks:
    - missing_values
    - duplicate_records
    - date_validity
    - code_validity
    - referential_integrity

cohort_balance_metrics:
  description: "Metrics for evaluating cohort balance"
  metrics:
    - standardized_mean_difference
    - variance_ratio
    - propensity_score_overlap
    - sample_size_ratio


# =============================================================================
# SECTION 5: QUERY INTENT CLASSIFICATION
# =============================================================================

intents:
  description: "User intent classification for cohort queries"
  
  DEFINE_COHORT:
    description: "Create new cohort definition"
    keywords: [define, create, build, specify, cohort]
    examples:
      - "Define a cohort of CSU patients"
      - "Create treatment-naive cohort"
      - "Build cohort with diagnosis in 2023"
  
  REFINE_COHORT:
    description: "Modify existing cohort definition"
    keywords: [refine, modify, update, add, remove, adjust]
    examples:
      - "Add exclusion for hospitalization"
      - "Remove age restriction"
      - "Refine temporal window to 90 days"
  
  VALIDATE_COHORT:
    description: "Check cohort validity"
    keywords: [validate, check, verify, test]
    examples:
      - "Validate cohort definition"
      - "Check for temporal inconsistencies"
      - "Verify cohort size"
  
  COMPARE_COHORTS:
    description: "Compare multiple cohorts"
    keywords: [compare, difference, overlap, match]
    examples:
      - "Compare treatment vs control"
      - "Show overlap between cohorts"
      - "What's the difference in baseline characteristics"
  
  DESCRIBE_COHORT:
    description: "Get cohort statistics and characteristics"
    keywords: [describe, summarize, show, statistics, characteristics]
    examples:
      - "Describe baseline characteristics"
      - "Show cohort demographics"
      - "Summarize treatment patterns"
  
  EXPORT_COHORT:
    description: "Export cohort for analysis"
    keywords: [export, save, download, generate]
    examples:
      - "Export patient list"
      - "Save cohort definition"
      - "Generate SQL query"


# =============================================================================
# SECTION 6: ALIASES & FUZZY MATCHING
# =============================================================================

aliases:
  # Clinical terms
  diagnosis:
    - dx
    - diagnosed
    - diagnoses
    - condition
  
  prescription:
    - rx
    - prescribed
    - medication
    - drug
    - treatment
  
  procedure:
    - proc
    - surgery
    - operation
    - intervention
  
  lab_test:
    - lab
    - test
    - laboratory
    - bloodwork
  
  # Temporal terms
  before:
    - prior to
    - earlier than
    - preceding
  
  after:
    - following
    - subsequent to
    - later than
  
  within:
    - during
    - in the period of
    - inside
  
  # Cohort terms
  cohort:
    - group
    - population
    - patient set
    - subset
  
  inclusion:
    - include
    - must have
    - required
    - with
  
  exclusion:
    - exclude
    - must not have
    - without
    - no
  
  # Statistical terms
  matched:
    - propensity matched
    - PSM
    - balanced
  
  control:
    - comparison
    - untreated
    - reference


# =============================================================================
# SECTION 7: EXAMPLE QUERIES
# =============================================================================

example_queries:
  description: "Example natural language queries for few-shot learning"
  
  basic_cohort_definition:
    - query: "Define a cohort of CSU patients diagnosed in 2023"
      intent: DEFINE_COHORT
      entities:
        diagnosis: [L50.1]
        temporal_window: [2023-01-01, 2023-12-31]
        temporal_anchor: diagnosis_date
    
    - query: "Create treatment-naive cohort with no prior therapy"
      intent: DEFINE_COHORT
      entities:
        criterion_type: exclusion_criterion
        prescription: any
        temporal_operator: before
  
  temporal_relationships:
    - query: "Patients prescribed Remibrutinib within 90 days of diagnosis"
      intent: DEFINE_COHORT
      entities:
        brand: Remibrutinib
        temporal_operator: within_days
        temporal_days: 90
        temporal_anchor: diagnosis_date
    
    - query: "Cohort with lab test at least 30 days after first prescription"
      intent: DEFINE_COHORT
      entities:
        criterion_type: lab_criterion
        temporal_operator: at_least_days_after
        temporal_days: 30
        temporal_anchor: first_prescription_date
  
  exclusion_criteria:
    - query: "Exclude patients with hospitalization during baseline"
      intent: REFINE_COHORT
      entities:
        criterion_category: exclusion
        procedure: hospitalization
        temporal_window: baseline_period
    
    - query: "No patients with prior cancer diagnosis"
      intent: REFINE_COHORT
      entities:
        criterion_category: exclusion
        diagnosis: [C00-C97]  # Cancer ICD-10 range
        temporal_operator: before
  
  cohort_comparison:
    - query: "Compare baseline characteristics between treatment and control"
      intent: COMPARE_COHORTS
      entities:
        comparison_type: baseline_characteristics
        cohort_types: [treatment, control]
    
    - query: "Show propensity score overlap"
      intent: DESCRIBE_COHORT
      entities:
        metric: propensity_score_overlap
  
  cohort_validation:
    - query: "Validate temporal consistency"
      intent: VALIDATE_COHORT
      entities:
        validation_rule: temporal_consistency
    
    - query: "Check if cohort size meets minimum threshold"
      intent: VALIDATE_COHORT
      entities:
        validation_rule: minimum_cohort_size


# =============================================================================
# SECTION 8: SCHEMA REFERENCES
# =============================================================================

database_tables:
  description: "Supabase tables used by CohortConstructor"
  tables:
    - cohort_definitions
    - cohort_criteria
    - patient_cohort_membership
    - cohort_validation_results
    - temporal_relationships

sql_templates:
  description: "Pre-defined SQL patterns for common cohort operations"
  templates:
    - name: basic_inclusion
      pattern: "SELECT DISTINCT patient_id FROM {table} WHERE {condition}"
    
    - name: temporal_join
      pattern: |
        SELECT a.patient_id 
        FROM {table_a} a
        JOIN {table_b} b ON a.patient_id = b.patient_id
        WHERE {temporal_condition}
    
    - name: exclusion_filter
      pattern: |
        SELECT patient_id FROM {cohort_table}
        WHERE patient_id NOT IN (
          SELECT patient_id FROM {exclusion_table}
          WHERE {exclusion_condition}
        )


# =============================================================================
# SECTION 9: CONFIGURATION & DEFAULTS
# =============================================================================

defaults:
  description: "Default values for cohort construction"
  
  temporal_defaults:
    baseline_period_days: 180
    followup_period_days: 365
    washout_period_days: 30
    
  validation_thresholds:
    minimum_cohort_size: 30
    maximum_missing_rate: 0.2
    smd_threshold: 0.1
    
  query_limits:
    max_criteria_per_cohort: 20
    max_temporal_relationships: 10
    max_cohort_size: 1000000

feature_flags:
  description: "Toggle advanced cohort features"
  flags:
    enable_propensity_matching: true
    enable_synthetic_controls: false
    enable_temporal_validation: true
    enable_balance_checking: true


# =============================================================================
# SECTION 10: ERROR CODES & MESSAGES
# =============================================================================

error_codes:
  description: "Standardized error codes for cohort construction"
  
  EMPTY_COHORT:
    code: "COHORT_001"
    message: "Cohort definition resulted in 0 patients"
    severity: error
    
  TEMPORAL_INCONSISTENCY:
    code: "COHORT_002"
    message: "Temporal relationships are logically inconsistent"
    severity: error
    
  INSUFFICIENT_SIZE:
    code: "COHORT_003"
    message: "Cohort size below minimum threshold"
    severity: warning
    
  CIRCULAR_DEPENDENCY:
    code: "COHORT_004"
    message: "Criterion dependencies form a cycle"
    severity: error
    
  INVALID_CODE:
    code: "COHORT_005"
    message: "Invalid diagnosis/procedure/drug code format"
    severity: error
    
  MISSING_ANCHOR:
    code: "COHORT_006"
    message: "Temporal relationship missing required anchor date"
    severity: error


# =============================================================================
# END OF COHORT VOCABULARY v1.0.0
# =============================================================================
