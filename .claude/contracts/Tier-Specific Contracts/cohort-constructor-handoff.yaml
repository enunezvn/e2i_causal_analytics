# CohortConstructor Agent Handoff
# Version: 1.0
# Last Updated: 2026-01-15
# Purpose: Define handoff structure for cohort_constructor agent

# ==============================================================================
# COHORT_CONSTRUCTOR HANDOFF
# ==============================================================================

cohort_constructor_handoff:
  agent: cohort_constructor
  analysis_type: cohort_construction
  status: completed
  confidence: 0.95

  key_findings:
    - "Cohort constructed: Remibrutinib CSU eligible population"
    - "Input: 50,000 patients screened"
    - "Eligible: 8,500 patients (17.0%)"
    - "Top exclusion: Insufficient UAS7 severity (60%)"
    - "Temporal validation: 95% passed lookback/followup"

  outputs:
    # === COHORT SPECIFICATION ===
    cohort_spec:
      cohort_id: "cohort_remibrutinib_csu_v1_20260115"
      cohort_name: "Remibrutinib CSU Eligible Population"
      brand: "Remibrutinib"
      indication: "csu"
      
      # Inclusion criteria applied
      inclusion_criteria:
        - field: age_at_diagnosis
          operator: ">="
          value: 18
          description: "Age ≥18 years"
          clinical_rationale: "Adult population per FDA label"
          
        - field: diagnosis_code
          operator: "in"
          value: ["L50.0", "L50.1", "L50.8", "L50.9"]
          description: "ICD-10: CSU diagnosis"
          clinical_rationale: "Chronic spontaneous urticaria codes"
          
        - field: urticaria_severity_uas7
          operator: ">="
          value: 16
          description: "UAS7 ≥16 (moderate-to-severe)"
          clinical_rationale: "Trial inclusion threshold"
          
        - field: antihistamine_failures_count
          operator: ">="
          value: 1
          description: "≥1 antihistamine failure"
          clinical_rationale: "Refractory to standard therapy"
          
      # Exclusion criteria applied
      exclusion_criteria:
        - field: is_pregnant
          operator: "=="
          value: true
          description: "Pregnancy"
          clinical_rationale: "Safety exclusion per label"
          
        - field: immunodeficiency_severe
          operator: "=="
          value: true
          description: "Severe immunodeficiency"
          clinical_rationale: "Safety concern"
          
      # Temporal requirements
      lookback_days: 180
      followup_days: 90
      index_date_field: "diagnosis_date"
      
      # Version control
      version: "1.0.0"
      config_hash: "a3f8d9e2c1b7..."  # SHA256 of config
      status: "locked"
      
    # === ELIGIBLE POPULATION ===
    eligible_patients:
      patient_ids:
        - "pj_001"
        - "pj_042"
        - "pj_089"
        # ... 8,500 total
      count: 8500
      
    # === ELIGIBILITY STATISTICS ===
    eligibility_stats:
      total_input_patients: 50000
      eligible_patient_count: 8500
      exclusion_rate: 0.83  # 83% excluded
      
      # Per-criterion tracking
      eligibility_log:
        - criterion_name: "age_at_diagnosis"
          criterion_type: "inclusion"
          criterion_order: 1
          removed_count: 8000
          remaining_count: 42000
          description: "Age ≥18 years"
          
        - criterion_name: "diagnosis_code"
          criterion_type: "inclusion"
          criterion_order: 2
          removed_count: 2000
          remaining_count: 40000
          description: "ICD-10: CSU diagnosis"
          
        - criterion_name: "urticaria_severity_uas7"
          criterion_type: "inclusion"
          criterion_order: 3
          removed_count: 30000
          remaining_count: 10000
          description: "UAS7 ≥16 (moderate-to-severe)"
          
        - criterion_name: "antihistamine_failures_count"
          criterion_type: "inclusion"
          criterion_order: 4
          removed_count: 500
          remaining_count: 9500
          description: "≥1 antihistamine failure"
          
        - criterion_name: "is_pregnant"
          criterion_type: "exclusion"
          criterion_order: 5
          removed_count: 500
          remaining_count: 9000
          description: "Pregnancy"
          
        - criterion_name: "immunodeficiency_severe"
          criterion_type: "exclusion"
          criterion_order: 6
          removed_count: 100
          remaining_count: 8900
          description: "Severe immunodeficiency"
          
      # Temporal validation
      temporal_validation:
        passed: true
        lookback_exclusions: 300
        followup_exclusions: 100
        total_temporal_exclusions: 400  # Final: 8,900 - 400 = 8,500
        
    # === EXECUTION METADATA ===
    execution_metadata:
      execution_id: "exec_20260115_143022"
      execution_timestamp: "2026-01-15T14:30:22Z"
      execution_time_ms: 45230
      
      # Node latencies
      node_latencies:
        validate_config_ms: 42
        apply_criteria_ms: 28500
        validate_temporal_ms: 15200
        generate_metadata_ms: 1488
        
      # Database records created
      database_records:
        cohort_definition_id: "cohort_remibrutinib_csu_v1_20260115"
        cohort_execution_id: "exec_20260115_143022"
        eligibility_log_entries: 6
        patient_assignments: 8500
        
    # === SUMMARY ===
    summary:
      summary_report: |
        Cohort constructed for Remibrutinib CSU eligible population.
        
        Population Screening:
        - Input: 50,000 patients screened
        - Eligible: 8,500 patients (17.0%)
        - Excluded: 41,500 patients (83.0%)
        
        Top Exclusion Reasons:
        1. Insufficient UAS7 severity (<16): 30,000 patients (60%)
        2. Age <18 years: 8,000 patients (16%)
        3. Missing CSU diagnosis code: 2,000 patients (4%)
        4. Pregnancy: 500 patients (1%)
        
        Temporal Eligibility:
        - Lookback period (180 days): 95% satisfied
        - Followup period (90 days): 98% satisfied
        - Total temporal exclusions: 400 patients (4.5% of inclusion-eligible)
        
        Cohort Characteristics:
        - Cohort size: 8,500 patients
        - Configuration: Locked (version 1.0.0)
        - Regulatory compliance: Full audit trail generated
        
        Ready for data_preparer quality validation.
        
      recommended_actions:
        - "Proceed to data_preparer with 8,500 eligible patients"
        - "Validate feature availability for eligible cohort"
        - "Monitor UAS7 severity distribution in eligible population"

  assumptions:
    - "Patient data is current and complete"
    - "Eligibility criteria reflect clinical trial entry requirements"
    - "Temporal requirements (180d lookback, 90d followup) are achievable"
    - "Configuration is locked and will not change during analysis"

  limitations:
    - "Cannot validate clinical accuracy of diagnosis codes"
    - "Temporal validation depends on data completeness"
    - "Cohort size (8,500) may be insufficient for rare subgroup analysis"

  warnings:
    - "High exclusion rate (83%) may indicate overly restrictive criteria"
    - "Consider relaxing UAS7 threshold if cohort too small for modeling"

  requires_further_analysis: false
  suggested_next_agent: data_preparer
  
  context_for_next_agent:
    cohort_id: "cohort_remibrutinib_csu_v1_20260115"
    eligible_patient_ids: ["pj_001", "pj_042", ...]  # 8,500 IDs
    cohort_spec:
      inclusion_criteria: [...]  # Full spec
      exclusion_criteria: [...]
      temporal_requirements:
        lookback_days: 180
        followup_days: 90
    quality_checks_required:
      - "validate_temporal_completeness"
      - "check_feature_availability_for_eligible_patients"
      - "validate_target_variable_presence"

# ==============================================================================
# HANDOFF USAGE PATTERNS
# ==============================================================================

# Pattern 1: scope_definer → cohort_constructor → data_preparer
tier0_cohort_pipeline:
  description: "ML Foundation pipeline with cohort construction"
  flow:
    - agent: scope_definer
      handoff: "scope_definer_handoff"
      next: cohort_constructor
      
    - agent: cohort_constructor
      receives: "scope_definer_handoff"
      handoff: "cohort_constructor_handoff"
      next: data_preparer
      context: "Eligible patient IDs and cohort specification"
      
    - agent: data_preparer
      receives: "cohort_constructor_handoff"
      handoff: "data_preparer_handoff"
      gate: "QC_GATE"  # Blocks if QC fails on eligible cohort
      next: model_selector
      context: "QC validates quality of eligible cohort ONLY"

# ==============================================================================
# EMPTY COHORT HANDOFF (ERROR CASE)
# ==============================================================================

cohort_constructor_empty_handoff:
  agent: cohort_constructor
  analysis_type: cohort_construction
  status: partial
  confidence: 0.60

  key_findings:
    - "Cohort construction completed with WARNINGS"
    - "Input: 50,000 patients screened"
    - "Eligible: 0 patients (0.0%)"
    - "All patients excluded by eligibility criteria"
    - "Top exclusion: Insufficient UAS7 severity (100%)"

  outputs:
    eligible_patients:
      patient_ids: []
      count: 0
      
    eligibility_stats:
      total_input_patients: 50000
      eligible_patient_count: 0
      exclusion_rate: 1.00  # 100% excluded
      
      eligibility_log:
        - criterion_name: "age_at_diagnosis"
          criterion_type: "inclusion"
          removed_count: 8000
          remaining_count: 42000
          
        - criterion_name: "urticaria_severity_uas7"
          criterion_type: "inclusion"
          removed_count: 42000
          remaining_count: 0  # ← ALL REMOVED
          
    summary:
      summary_report: |
        EMPTY COHORT: All 50,000 patients excluded.
        
        Root Cause:
        - UAS7 ≥16 requirement removed 100% of age-eligible patients
        
        Recommended Actions:
        1. Relax UAS7 threshold (try UAS7 ≥12)
        2. Validate data quality (check for missing UAS7 values)
        3. Review clinical criteria with medical team
        
      recommended_actions:
        - "BLOCK pipeline: Cannot proceed with empty cohort"
        - "Relax UAS7 threshold from 16 to 12"
        - "Investigate data quality: 84% of patients have missing UAS7"

  warnings:
    - "EMPTY COHORT: All patients excluded"
    - "Pipeline BLOCKED: data_preparer cannot validate empty cohort"
    - "Criteria may be too restrictive or data quality issue present"

  errors:
    - error_code: "CC_003"
      category: "EMPTY_COHORT"
      message: "All 50,000 patients excluded by eligibility criteria"
      recovery_suggestions:
        - "Relax UAS7 threshold"
        - "Validate data quality"
        - "Review criteria with clinical team"

  requires_further_analysis: true
  suggested_next_agent: null  # BLOCK pipeline
  
  context_for_next_agent:
    pipeline_blocked: true
    block_reason: "Empty cohort (0 eligible patients)"
    resolution_required: "Adjust criteria or fix data quality"

# ==============================================================================
# MULTI-BRAND HANDOFF (BATCH PROCESSING)
# ==============================================================================

cohort_constructor_multi_brand_handoff:
  agent: cohort_constructor
  analysis_type: cohort_construction_batch
  status: completed
  confidence: 0.92

  key_findings:
    - "3 cohorts constructed: Remibrutinib, Fabhalta, Kisqali"
    - "Total input: 150,000 patients (50K per brand)"
    - "Total eligible: 25,500 patients (17.0%)"
    - "All cohorts passed minimum size threshold (>100)"
    - "All cohorts locked and ready for parallel training"

  outputs:
    cohorts:
      - brand: "Remibrutinib"
        cohort_id: "cohort_remibrutinib_csu_v1"
        eligible_count: 8500
        exclusion_rate: 0.83
        
      - brand: "Fabhalta"
        cohort_id: "cohort_fabhalta_pnh_v1"
        eligible_count: 3200
        exclusion_rate: 0.94
        
      - brand: "Kisqali"
        cohort_id: "cohort_kisqali_hr_her2_v1"
        eligible_count: 13800
        exclusion_rate: 0.72
        
    summary:
      summary_report: |
        Multi-brand cohort construction completed.
        
        Brand-Specific Results:
        1. Remibrutinib CSU: 8,500 / 50,000 (17%)
        2. Fabhalta PNH: 3,200 / 50,000 (6%)
        3. Kisqali HR+/HER2-: 13,800 / 50,000 (28%)
        
        All cohorts meet minimum size (>100) and are locked for training.

  requires_further_analysis: false
  suggested_next_agent: data_preparer
  
  context_for_next_agent:
    parallel_processing: true
    cohort_ids: [
      "cohort_remibrutinib_csu_v1",
      "cohort_fabhalta_pnh_v1",
      "cohort_kisqali_hr_her2_v1"
    ]
    processing_mode: "batch"

# ==============================================================================
# VALIDATION SCHEMA
# ==============================================================================

cohort_constructor_validation:
  required_keys:
    - agent
    - analysis_type
    - status
    - confidence
    - key_findings
    - outputs
    - outputs.cohort_spec
    - outputs.eligible_patients
    - outputs.eligibility_stats
    
  type_checks:
    agent: string  # Must be "cohort_constructor"
    analysis_type: string  # "cohort_construction" | "cohort_construction_batch"
    status: string  # "completed" | "partial" | "failed"
    confidence: float  # 0.0-1.0
    key_findings: array  # 3-5 items
    
  conditional_requirements:
    # If status is "completed", eligible_patient_count must be > 0
    - if:
        status: completed
      then:
        required: [outputs.eligible_patients.count]
        validation: outputs.eligible_patients.count > 0
        
    # If status is "partial" and eligible_count == 0, errors must be present
    - if:
        status: partial
        outputs.eligible_patients.count: 0
      then:
        required: [errors]
        validation: errors[0].error_code == "CC_003"

# ==============================================================================
# END OF COHORT_CONSTRUCTOR HANDOFF SPECIFICATION
# ==============================================================================
