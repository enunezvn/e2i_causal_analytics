# Optuna Hyperparameter Optimization Configuration
# This configuration controls HPO behavior across E2I ML pipelines.

# Storage configuration
storage:
  # Database URL for persistent storage (uses env variable if set)
  # Supports: sqlite:///path/to/db, postgresql://..., mysql://...
  url: "${OPTUNA_STORAGE_URL:-sqlite:///optuna_studies.db}"

  # Enable storage (if false, uses in-memory storage)
  enabled: true

# Default sampler configuration (Tree-structured Parzen Estimator)
sampler:
  # Sampler type: tpe, random, grid, cmaes
  type: tpe

  # TPE-specific settings
  tpe:
    # Random seed for reproducibility
    seed: 42
    # Number of random trials before TPE kicks in
    n_startup_trials: 10
    # Enable multivariate TPE (considers parameter dependencies)
    multivariate: true
    # Consider prior distribution
    consider_prior: true
    # Prior weight
    prior_weight: 1.0

# Default pruner configuration
pruner:
  # Pruner type: median, successive_halving, hyperband, threshold, none
  type: median

  # Median pruner settings
  median:
    # Trials to run before pruning kicks in
    n_startup_trials: 5
    # Steps before pruning can happen
    n_warmup_steps: 10
    # Interval between pruning checks
    interval_steps: 1

  # Successive halving settings (alternative)
  successive_halving:
    min_resource: 1
    reduction_factor: 3
    min_early_stopping_rate: 0

  # Hyperband settings (alternative)
  hyperband:
    min_resource: 1
    max_resource: 100
    reduction_factor: 3

# Optimization defaults
optimization:
  # Default number of trials
  default_n_trials: 50

  # Default timeout in seconds (None for no timeout)
  default_timeout: null

  # Number of parallel jobs (1 for sequential, -1 for all cores)
  n_jobs: 1

  # Show progress bar during optimization
  show_progress_bar: false

  # Catch exceptions during optimization (prevents single trial from failing study)
  catch_exceptions: true

# Warm-start configuration (uses procedural memory)
warmstart:
  # Enable warm-starting from previous similar studies
  enabled: true

  # Minimum similarity score to consider for warm-start (0.0-1.0)
  min_similarity: 0.7

  # Maximum number of warm-start trials to import
  max_import_trials: 20

  # Prioritize best trials from previous studies
  prioritize_best: true

  # Memory table for warm-start patterns
  pattern_table: hpo_pattern_memory

# MLflow integration
mlflow:
  # Enable MLflow tracking for HPO runs
  enabled: true

  # Log individual trial metrics
  log_trials: true

  # Log best parameters at end of study
  log_best_params: true

  # Experiment name prefix for HPO runs
  experiment_prefix: "hpo_"

# Opik integration
opik:
  # Enable Opik tracing for HPO
  enabled: true

  # Trace individual trials
  trace_trials: false

  # Project name for HPO traces
  project_name: "e2i_hpo"

# Problem-type specific defaults
problem_types:
  binary_classification:
    default_metric: roc_auc
    direction: maximize
    cv_folds: 5

  multiclass_classification:
    default_metric: f1_weighted
    direction: maximize
    cv_folds: 5

  regression:
    default_metric: neg_root_mean_squared_error
    direction: maximize
    cv_folds: 5

# Model-specific search spaces (commonly used presets)
search_space_presets:
  xgboost_classifier:
    n_estimators:
      type: int
      low: 50
      high: 500
      step: 50
    max_depth:
      type: int
      low: 3
      high: 10
    learning_rate:
      type: float
      low: 0.01
      high: 0.3
      log: true
    subsample:
      type: float
      low: 0.6
      high: 1.0
    colsample_bytree:
      type: float
      low: 0.6
      high: 1.0
    min_child_weight:
      type: int
      low: 1
      high: 10
    reg_alpha:
      type: float
      low: 0.0001
      high: 1.0
      log: true
    reg_lambda:
      type: float
      low: 0.0001
      high: 1.0
      log: true

  lightgbm_classifier:
    n_estimators:
      type: int
      low: 50
      high: 500
      step: 50
    max_depth:
      type: int
      low: 3
      high: 12
    learning_rate:
      type: float
      low: 0.01
      high: 0.3
      log: true
    num_leaves:
      type: int
      low: 20
      high: 100
    feature_fraction:
      type: float
      low: 0.5
      high: 1.0
    bagging_fraction:
      type: float
      low: 0.5
      high: 1.0
    min_child_samples:
      type: int
      low: 5
      high: 100

  random_forest:
    n_estimators:
      type: int
      low: 50
      high: 300
      step: 25
    max_depth:
      type: int
      low: 5
      high: 30
    min_samples_split:
      type: int
      low: 2
      high: 20
    min_samples_leaf:
      type: int
      low: 1
      high: 10
    max_features:
      type: categorical
      choices: ["sqrt", "log2", null]

# Resource limits
limits:
  # Maximum trials per study
  max_trials_per_study: 500

  # Maximum concurrent studies
  max_concurrent_studies: 3

  # Maximum study duration (seconds)
  max_study_duration: 7200  # 2 hours

  # Memory limit per trial (MB) - for monitoring
  max_memory_mb: 4096

# Alerting for HPO
alerting:
  # Enable alerting
  enabled: true

  # Alert on study failure
  alert_on_failure: true

  # Alert if no improvement after N trials
  no_improvement_threshold: 25

  # Alert channels
  channels:
    - type: log
      level: warning
